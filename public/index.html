<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Alesis Soundstage</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#101821; --glass:rgba(20,40,55,.55); --glass-brd:#244253;
    --ink:#eaf6ff; --muted:#b9c9d6; --card-brd:#2b3642; --cyan:#14e3ff; --radius:14px;
  }
  html,body{height:100%}
  body{
    margin:0; color:var(--ink); background:var(--bg);
    background-image:
      radial-gradient(800px 520px at 85% 10%, rgba(0,200,255,.10) 0%, transparent 60%),
      radial-gradient(600px 420px at 15% 70%, rgba(0,200,255,.08) 0%, transparent 55%);
    font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  }
  .wrap{max-width:1180px; margin:24px auto; padding:0 16px}
  header{display:flex;align-items:center;justify-content:space-between;background:var(--glass);border:1px solid var(--glass-brd);border-radius:12px;padding:10px 12px;position:sticky;top:12px;backdrop-filter:blur(10px)}
  .brand{display:flex;gap:8px;align-items:center;font-weight:800}
  .brand .pill{background:#0d2633;color:#8deaff;padding:4px 8px;border-radius:999px;font-size:12px}
  .btn{border:1px solid var(--glass-brd);border-radius:999px;padding:8px 14px;background:#0f1a22;color:#cfe8f5;font-weight:700;cursor:pointer}
  .btn:hover{box-shadow:0 0 0 3px #2fd3ff55}
  .btn-primary{background:#00a7bb;color:#00171c;border-color:#008da0}
  .btn-ghost{background:transparent}
  .count{display:inline-block;min-width:22px;height:22px;line-height:22px;padding:0 6px;border-radius:999px;background:#032e36;border:1px solid #0e3e47;color:#8cf7ff;font-weight:800;margin-left:8px;text-align:center;font-size:12px}

  .chips{display:flex;flex-wrap:wrap;gap:10px;margin:16px 0 10px}
  .chip{background:#0d2633;border:1px solid #203748;color:#bfefff;padding:7px 12px;border-radius:999px;cursor:pointer;font-weight:700}
  .chip.active{background:#11b6cc;color:#002028;border-color:#11b6cc}
  .desc{color:#9fb4c4}

  #grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
  @media (max-width:980px){#grid{grid-template-columns:repeat(2,1fr)}}
  @media (max-width:640px){#grid{grid-template-columns:1fr}}

  .card{border:1px solid var(--card-brd);border-radius:var(--radius);overflow:hidden;background:#0d141c;display:flex;flex-direction:column;min-height:360px}
  .imgbox{position:relative;width:100%;height:230px;background:#0a1319}
  .imgbox img{width:100%;height:100%;object-fit:cover;display:block;background:#0a1319}
  .demo{position:absolute;top:10px;left:10px;background:#ffd803;color:#111;font-weight:800;border-radius:999px;padding:6px 10px;box-shadow:0 6px 20px rgba(0,0,0,.35)}
  .content{padding:12px}
  .title{font-weight:800;margin:6px 0 2px 0}
  .subtitle{color:#95a9b8;font-size:12px}
  .price-chip{display:inline-block;background:#032e36;color:#00e5ff;border:1px solid #0e3e47;border-radius:999px;padding:6px 10px;font-weight:800}
  label.compare{display:flex;align-items:center;gap:8px;margin-top:8px;color:#a9c2cf}
  label.compare input{accent-color:#11b6cc}

  dialog{border:none;padding:0;background:transparent}
  dialog::backdrop{background:rgba(0,0,0,.65)}
  .sheet{background:var(--glass);border:1px solid var(--glass-brd);border-radius:var(--radius);box-shadow:0 20px 60px rgba(0,0,0,.55);color:var(--ink);width:min(1000px,92vw)}
  .sheet .head{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid var(--glass-brd)}
  .sheet .body{display:grid;grid-template-columns:52% 48%;gap:18px;padding:14px}
  @media (max-width:820px){.sheet .body{grid-template-columns:1fr}}

  .detail-img{background:#0a1319;border-radius:12px;overflow:hidden;padding:10px}
  .detail-img img{width:100%;height:320px;object-fit:cover;border-radius:10px;background:#0a1319}

  /* section text forced to white */
  .sheet .section{border:1px solid var(--glass-brd);border-radius:12px;padding:12px;margin-top:12px;background:rgba(0,20,28,.45)}
  .sheet .section, .sheet .section *{color:#fff!important;opacity:1!important;mix-blend-mode:normal!important;text-shadow:none!important}
  .sheet .section h4{margin:0 0 6px 0;font-weight:800}
  .sheet .section .muted, .sheet .section p{color:#eaf6ff!important}
  .sheet .section ul{padding-left:18px;margin:0;list-style:disc}
  .sheet .section li{list-style:disc;padding:3px 0}
  .sheet .section li::marker{color:#21d3e6}
  .chip.upc{background:#032e36;border:1px solid #0e3e47;color:#c6faff;font-weight:700;margin-left:8px}

  /* compare modal */
  #compare .sheet{width:min(1100px,96vw)}
  .cmp-grid{display:grid;gap:12px;padding:14px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
  .cmp-card{border:1px solid var(--glass-brd);border-radius:12px;padding:10px;background:rgba(10,18,26,.6)}
  .cmp-card .img{width:100%;height:180px;background:#0a1319;border-radius:10px;overflow:hidden;margin-bottom:8px}
  .cmp-card .img img{width:100%;height:100%;object-fit:cover}
  .spec{margin-top:6px}
  .spec div{display:flex;justify-content:space-between;border-bottom:1px dashed #27424f;padding:6px 0}
  .spec div span:first-child{color:#b7d1df}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand"><div>ALESIS</div><div class="pill">DRUMS</div></div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="btnCompare" class="btn">Compare <span class="count">0</span></button>
        <button id="btnWizard" class="btn">Find my kit</button>
      </div>
    </header>

    <h2 style="margin:18px 0 6px 0">Electronic Drum Range</h2>
    <div class="desc">Compare features and choose the perfect Alesis kit for practice, recording, or performance.</div>

    <div id="chips" class="chips">
      <button class="chip active" data-filter="All">All</button>
      <button class="chip" data-filter="Drum Kits">Electronic Drum Kits</button>
      <button class="chip" data-filter="Multipads & Drum Machines">Multipads & Drum Machines</button>
      <button class="chip" data-filter="Drum Amplification">Drum Amplification</button>
      <button class="chip" data-filter="Accessories">Accessories</button>
      <button class="chip" data-filter="On Demo">On Demo</button>
    </div>

    <div id="grid"></div>
  </div>

  <dialog id="detailWrap" aria-label="Product detail"></dialog>

  <dialog id="wizard" aria-label="Find my kit">
    <div class="sheet">
      <div class="head"><strong>Find My Perfect Kit</strong><button class="btn" data-close="1">Close</button></div>
      <div class="body">
        <div>
          <div class="form" style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <div><div class="muted" style="margin-bottom:6px">Experience</div>
              <select id="wExp"><option>Beginner</option><option selected>Intermediate</option><option>Advanced</option></select></div>
            <div><div class="muted" style="margin-bottom:6px">Budget</div>
              <select id="wBudget"><option>AED 1,000 – 2,000</option><option selected>AED 2,000 – 5,000</option><option>AED 5,000+</option></select></div>
            <div><div class="muted" style="margin-bottom:6px">Space</div>
              <select id="wSpace"><option>Compact</option><option selected>Standard</option><option>Large</option></select></div>
            <div><div class="muted" style="margin-bottom:6px">Goal</div>
              <select id="wGoal"><option>Learning</option><option selected>Recording</option><option>Performing</option></select></div>
            <div><div class="muted" style="margin-bottom:6px">Noise Sensitivity</div>
              <select id="wNoise"><option>Low</option><option selected>Medium</option><option>High (keep it quiet)</option></select></div>
            <div><div class="muted" style="margin-bottom:6px">Connectivity Preference</div>
              <select id="wConn"><option selected>No preference</option><option>USB/MIDI</option><option>Bluetooth</option></select></div>
          </div>
          <div style="margin-top:12px;display:flex;gap:8px">
            <button id="wGo" class="btn btn-primary">Get Recommendation</button>
            <button class="btn" data-close="1">Close</button>
          </div>
        </div>
        <div id="wizOut"></div>
      </div>
    </div>
  </dialog>

  <dialog id="compare" aria-label="Compare kits">
    <div class="sheet">
      <div class="head"><strong>Compare</strong><button class="btn" data-close="1">Close</button></div>
      <div class="cmp-grid" id="cmpGrid"></div>
    </div>
  </dialog>

  <script src="/env.js"></script>
  <script>
  (function(){
    const $=(s,p=document)=>p.querySelector(s);
    const $$=(s,p=document)=>Array.from(p.querySelectorAll(s));
    const AED=n=>'AED '+Number(n||0).toLocaleString('en-AE',{minimumFractionDigits:2,maximumFractionDigits:2});
    const state={rows:[],byId:new Map(),filterLabel:'All',compare:new Set()};
    const CATEGORY=new Map([['All',null],['Drum Kits','Drum Kits'],['Multipads & Drum Machines','Accessories'],['Drum Amplification','Drum Amps'],['Accessories','Accessories'],['On Demo','__demo__']]);
    const PLACEHOLDER='data:image/svg+xml;utf8,'+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="800" height="600"><rect width="100%" height="100%" fill="#0a1319"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="system-ui,Segoe UI,Arial" font-size="18" fill="#7fa7ba">Image</text></svg>');

    function getUPC(r){ return r?.upc||r?.ean||r?.barcode||r?.sku||r?.product_code||r?.mpn||r?.code||null; }
    function pickImage(r,kind){
      const direct=(kind==='detail'&&(r?.detail_image_url||(Array.isArray(r?.images)&&r.images[1])))
        || r?.primary_image_url || r?.image_url || (Array.isArray(r?.images)?r.images[0]:null);
      const fromStore=r?.image_path ? (window.ENV.SUPABASE_URL+'/storage/v1/object/public/'+r.image_path) : null;
      return direct || fromStore || PLACEHOLDER;
    }
    function updateCompareCount(){ const c=state.compare.size; const b=$('#btnCompare .count'); if(b) b.textContent=String(c); }

    async function load(){
      const url=window.ENV?.SUPABASE_URL, key=window.ENV?.SUPABASE_ANON_KEY;
      if(!url||!key){ $('#grid').innerHTML='<div class="card" style="padding:16px">env.js missing SUPABASE creds.</div>'; return; }
      try{
        const res=await fetch(url+'/rest/v1/drum_kits?select=*&order=price.asc',{headers:{apikey:key,Authorization:'Bearer '+key}});
        let rows=await res.json(); rows=rows.filter(r=>r?.is_active!==false);
        state.rows=rows; state.byId=new Map(rows.map(r=>[String(r.id),r])); render();
      }catch(e){ $('#grid').innerHTML='<div class="card" style="padding:16px">Network error loading products.</div>'; console.error(e); }
    }

    function render(){
      const grid=$('#grid'); let list=state.rows.slice(); const want=CATEGORY.get(state.filterLabel);
      if(want==='__demo__') list=list.filter(r=>r?.on_demo); else if(want) list=list.filter(r=>r?.category===want);
      if(!list.length){ grid.innerHTML='<div class="card" style="padding:16px">No items match this view.</div>'; return; }
      grid.innerHTML=list.map(r=>renderCard(r)).join('');
      $$('[data-explore]').forEach(b=>b.addEventListener('click',e=>openDetail(e.currentTarget.getAttribute('data-explore'))));
      $$('input[data-compare]').forEach(ch=>{
        const id=ch.getAttribute('data-compare');
        ch.checked=state.compare.has(id);
        ch.addEventListener('change',e=>{
          e.currentTarget.checked?state.compare.add(id):state.compare.delete(id);
          updateCompareCount();
        });
      });
    }

    function renderCard(r){
      const img=pickImage(r,'card');
      const demo=r?.on_demo?('<div class="demo">'+(r?.on_demo_label||'On Demo')+'</div>'):'';
      return '<div class="card">'
        + '<div class="imgbox">'+demo+'<img alt="'+(r?.name||'').replace(/"/g,'&quot;')+'" src="'+img+'"></div>'
        + '<div class="content">'
        +   '<div class="price-chip">'+AED(r?.price)+'</div>'
        +   '<div class="title">'+(r?.name||'')+'</div>'
        +   (r?.subtitle?'<div class="subtitle">'+r.subtitle+'</div>':'')
        +   '<div style="display:flex;gap:10px;align-items:center;margin-top:8px">'
        +     '<button class="btn btn-ghost" data-explore="'+r.id+'">Explore</button>'
        +     '<label class="compare"><input type="checkbox" data-compare="'+r.id+'"> Add to compare</label>'
        +   '</div>'
        + '</div></div>';
    }

    function openDetail(id){
      const r=state.byId.get(String(id)); if(!r) return;
      const dlg=$('#detailWrap'); const upc=getUPC(r);
      const demoChip=r?.on_demo?'<span class="chip upc" style="background:#ffd803;color:#111;border-color:#ffd803">'+(r.on_demo_label||'On Demo')+'</span>':'';
      const priceChip='<span class="price-chip">'+AED(r.price)+'</span>';
      const upcChip=upc?'<span class="chip upc">UPC: '+upc+'</span>':'';
      const features=Array.isArray(r?.features)?r.features:[]; const contents=Array.isArray(r?.contents)?r.contents:[];
      dlg.innerHTML=
        '<div class="sheet">'
        + '<div class="head"><strong>'+(r?.name||'')+'</strong><button class="btn" data-close="1">Close</button></div>'
        + '<div class="body">'
        +   '<div class="detail-img"><img src="'+pickImage(r,'detail')+'" alt=""></div>'
        +   '<div>'
        +     '<div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">'+demoChip+priceChip+upcChip+'</div>'
        +     (r?.description?('<div class="section"><h4>Description</h4><div class="muted">'+r.description+'</div></div>'):'')
        +     (features.length?('<div class="section"><h4>Key Features</h4><ul>'+features.map(f=>'<li>'+f+'</li>').join('')+'</ul></div>'):'')
        +     (contents.length?('<div class="section"><h4>What\'s Included</h4><ul>'+contents.map(c=>'<li>'+c+'</li>').join('')+'</ul></div>'):'')
        +   '</div>'
        + '</div></div>';
      dlg.addEventListener('click',e=>{ if(e.target?.dataset?.close) dlg.close(); },{once:true});
      dlg.showModal();
    }

    // Compare
    function openCompare(){
      const rows=[...state.compare].map(id=>state.byId.get(String(id))).filter(Boolean);
      const dlg=$('#compare'); const grid=$('#cmpGrid'); grid.innerHTML='';
      if(!rows.length){ grid.innerHTML='<div class="card" style="padding:16px">No items selected. Tick "Add to compare" on a few products.</div>'; dlg.showModal(); return; }
      const specLabels=[
        ['Category', r=>r?.category||'—'],
        ['On Demo', r=>r?.on_demo?'Yes':'No'],
        ['USB/MIDI', r=>r?.usb_midi?'Yes':'—'],
        ['Bluetooth', r=>r?.bluetooth_audio?'Yes':'—'],
        ['Factory kits', r=>r?.kits_factory ?? '—'],
        ['Toms', r=>r?.toms_count ?? '—'],
        ['Crash cymbals', r=>r?.crash_count ?? '—'],
        ['Ride zones', r=>r?.ride_zones ?? '—'],
        ['Kick tower', r=>r?.kick_tower===true?'Yes':(r?.kick_tower===false?'No':'—')]
      ];
      rows.forEach(r=>{
        const upc = (r?.upc||r?.ean||r?.barcode||r?.sku||'');
        const col = document.createElement('div');
        col.className='cmp-card';
        col.innerHTML =
          '<div class="img"><img src="'+pickImage(r,'card')+'" alt=""></div>'
        + '<div class="price-chip">'+AED(r.price)+'</div>'
        + (upc?'<span class="chip upc" style="margin-left:8px">UPC: '+upc+'</span>':'')
        + '<div class="title" style="margin-top:6px">'+(r?.name||'')+'</div>'
        + '<div class="spec">'
        +   specLabels.map(([label,get])=>{
              let v='—'; try{ v=get(r); }catch(_){}
              return '<div><span>'+label+'</span><span>'+String(v)+'</span></div>';
            }).join('')
        + '</div>'
        + '<div style="margin-top:10px;display:flex;gap:8px">'
        +   '<button class="btn btn-ghost" data-open="'+r.id+'">Explore</button>'
        +   '<button class="btn" data-remove="'+r.id+'">Remove</button>'
        + '</div>';
        grid.appendChild(col);
      });
      grid.querySelectorAll('[data-open]').forEach(b=>b.addEventListener('click',e=>{ dlg.close(); openDetail(e.currentTarget.getAttribute('data-open')); }));
      grid.querySelectorAll('[data-remove]').forEach(b=>b.addEventListener('click',e=>{
        const id=e.currentTarget.getAttribute('data-remove'); state.compare.delete(id); updateCompareCount(); render(); openCompare();
      }));
      dlg.addEventListener('click',e=>{ if(e.target?.dataset?.close) dlg.close(); });
      dlg.showModal();
    }

    // header wiring
    $('#chips').addEventListener('click',e=>{
      const btn=e.target.closest('.chip'); if(!btn) return;
      $$('#chips .chip').forEach(x=>x.classList.remove('active'));
      btn.classList.add('active'); state.filterLabel=btn.getAttribute('data-filter'); render();
    });
    $('#btnWizard').addEventListener('click',()=>{
      const dlg=$('#wizard'); $('#wizOut').innerHTML='<div class="desc">Pick your preferences, then click <b>Get Recommendation</b>.</div>';
      dlg.addEventListener('click',e=>{ if(e.target?.dataset?.close) dlg.close(); });
      dlg.showModal();
    });
    $('#wGo').addEventListener('click',()=>{
      const budget=$('#wBudget').value; const conn=$('#wConn').value;
      const priceMax=budget.includes('1,000')?2000:budget.includes('2,000')?5000:999999;
      const ranked=state.rows.filter(r=>(r.price||0)<=priceMax).map(r=>{
        let s=0; if(conn==='USB/MIDI' && r?.usb_midi) s+=2; if(conn==='Bluetooth' && r?.bluetooth_audio) s+=2; if(/mesh/i.test(r?.name||'')) s+=1;
        return {r,score:s};
      }).sort((a,b)=>b.score-a.score|| (a.r.price||0)-(b.r.price||0));
      if(!ranked.length){ $('#wizOut').innerHTML='<div class="card" style="padding:12px">No matches for that budget.</div>'; return; }
      const top=ranked[0].r;
      $('#wizOut').innerHTML='<div class="section"><h4>Your Match</h4><div><strong>'+top.name+'</strong> looks like a great fit at <b>'+AED(top.price)+'</b>.</div><div class="muted" style="margin-top:6px">Because it matches your budget and preferences.</div><div style="margin-top:10px"><button class="btn btn-primary" data-open="'+top.id+'">View This Kit</button></div></div>';
      $('#wizOut [data-open]').addEventListener('click',e=>{ $('#wizard').close(); openDetail(e.currentTarget.getAttribute('data-open')); });
    });
    $('#btnCompare').addEventListener('click', openCompare);

    window.addEventListener('DOMContentLoaded', load);
  })();
  </script>
</body>
</html>
