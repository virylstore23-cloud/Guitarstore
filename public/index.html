<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Alesis Kiosk</title>

<!-- Theme stays as-is; we only add scoped fixes -->
<style>
  :root{
    --ink: #e8ffff; --muted:#9ac8c8;
    --pill:#16a0a7; --pill-ink:#031f22;
    --chip:#0a3b41; --chip-brd:#0e5a63;
    --glass:#0b262a; --glass-brd:#10454c;
    --line:#1a5660; --warn:#ffca1b; --warn-ink:#0a0a0a;
    --danger:#fa4f4f;
  }

  body{ margin:0; font:16px/1.45 Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:#081419; color:var(--ink); }

  /* header (sticky) */
  header{ position:sticky; top:0; z-index:50; background:linear-gradient(180deg, rgba(8,20,25,.98), rgba(8,20,25,.65)); backdrop-filter:saturate(120%) blur(6px); }
  .bar{ max-width:1220px; margin:auto; padding:12px 16px; display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  .h-title{ font-weight:900; letter-spacing:.3px; margin-right:auto; }

  /* chips */
  .chip{ display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:22px; border:1px solid var(--chip-brd); background:var(--chip); color:#bfefff; font-weight:700; cursor:pointer; user-select:none; }
  .chip[aria-pressed="true"]{ outline:2px solid #36e1ff22; box-shadow:inset 0 0 0 1px #36e1ff33; }
  .muted{ color:var(--muted); font-weight:600; }

  /* grid */
  #grid{ max-width:1220px; margin:16px auto 80px; padding:0 16px;
         display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:16px; }

  .card{ position:relative; background:var(--glass); border:1px solid var(--glass-brd); border-radius:16px; overflow:hidden; cursor:pointer; padding-bottom:50px; }
  .card .img{ aspect-ratio: 16/9; width:100%; object-fit:cover; background:#000; display:block; }
  .pad{ padding:12px; }
  .pill{ display:inline-flex; align-items:center; gap:10px; padding:8px 14px; border-radius:999px; background:var(--pill); border:1px solid #27c7cf; color:var(--pill-ink); font-weight:900; }
  .pill.price{ font-size:16px; } /* keep price compact */
  .title{ font-weight:900; font-size:18px; margin:8px 0 4px; letter-spacing:.2px; }
  .sub{ color:var(--muted); font-weight:700; margin-bottom:10px; }

  /* dirham icon (always black) */
  .aed-icon{ width:16px; height:16px; display:inline-block; -webkit-mask:url("/aed.svg") no-repeat center / contain; mask:url("/aed.svg") no-repeat center / contain; background:#000; flex:0 0 16px; vertical-align:-2px; }

  .tagrow{ display:flex; gap:10px; flex-wrap:wrap; }
  .tag{ background:var(--chip); border:1px solid var(--chip-brd); color:#bfefff; padding:8px 12px; border-radius:999px; font-weight:800; }

  /* compare toggle pinned bottom-right */
  .cmpCtl{ position:absolute; right:12px; bottom:10px; display:flex; align-items:center; gap:8px; background:transparent; }
  .cmpCtl input{ width:18px; height:18px; accent-color:#4de2ff; }
  .cmpCtl label{ color:#d5faff; font-weight:800; }

  /* floating Compare FAB */
  #compareFab{ position:fixed; right:16px; bottom:16px; z-index:60; display:none; align-items:center; gap:10px; background:var(--pill); border:1px solid #27c7cf; color:var(--pill-ink); font-weight:900; border-radius:999px; padding:10px 16px; cursor:pointer; box-shadow:0 8px 26px #000a; }
  #compareFab .count{ background:#073238; color:#9ffaff; padding:3px 8px; border-radius:12px; border:1px solid #0e5a63; font-weight:900; }

  /* modal shell */
  #detail, #compare{ position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.6); z-index:80; }
  #detail .sheet, #compare .sheet{ width:min(1100px, 94vw); max-height:92vh; background:#07171b; border:1px solid var(--glass-brd); border-radius:18px; overflow:hidden; display:grid; grid-template-columns: 1fr 1fr; gap:0; }
  #detail .l { padding:14px; border-right:1px solid var(--glass-brd); }
  #detail .l img{ width:100%; height:100%; object-fit:contain; background:#000; border-radius:12px; }
  #detail .r { padding:12px; }

  /* Close pill pinned top-right of sheet */
  #detail .sheet{ position:relative; }
  #detail .close{ position:absolute; top:12px; right:12px; z-index:90; }
  .btn{ display:inline-flex; align-items:center; gap:8px; padding:8px 14px; border-radius:12px; border:1px solid var(--glass-brd); background:var(--glass); color:#bfefff; font-weight:900; cursor:pointer; }

  /* title row with small demo chip */
  .title-row{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin:6px 0 6px; }
  .pill-demo{ font-size:13px; line-height:1; padding:6px 10px; border-radius:18px; background:var(--warn); color:var(--warn-ink); border:1px solid #f2d057; max-width:300px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

  .panel{ border:1px solid var(--glass-brd); border-radius:14px; padding:12px; margin:10px 0; background:linear-gradient(180deg,#0b2227,#0a1f24); }
  .panel h3{ margin:0 0 8px; font-size:16px; letter-spacing:.3px; }
  .list{ margin:0; padding-left:18px; }
  .list li{ padding:3px 0; }

  .specs{ width:100%; border-collapse:collapse; }
  .specs td{ border-bottom:1px dotted var(--line); padding:8px 6px; }
  .specs td:first-child{ color:#bfefff; font-weight:800; width:40%; }

  /* compare modal */
  #cmpCols{ display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:14px; padding:12px; }
  #compare .col{ background:var(--glass); border:1px solid var(--glass-brd); border-radius:14px; overflow:hidden; }
  #compare .col .head{ padding:10px; display:flex; align-items:center; justify-content:space-between; }
  #compare .price{ margin-left:auto; }

  /* mobile: modal goes stacked */
  @media (max-width: 900px){
    #detail .sheet{ grid-template-columns:1fr; }
    #detail .l{ border-right:0; border-bottom:1px solid var(--glass-brd); max-height:40vh; }
    #detail .r{ max-height:52vh; overflow:auto; }
  }
</style>

<script defer src="/env.js"></script>
</head>
<body>
  <header>
    <div class="bar">
      <div class="h-title">ALESIS</div>
      <div id="chips"></div>
      <div class="chip" id="btnCompare" title="Open compare">Compare <span id="cmpCount" class="count" style="margin-left:6px;background:#073238;border:1px solid #0e5a63;border-radius:12px;padding:3px 8px;font-weight:900;">0</span></div>
    </div>
  </header>

  <main id="grid"></main>

  <!-- floating compare -->
  <div id="compareFab"><span>Compare</span><span class="count" id="fabCount">0</span></div>

  <!-- detail modal -->
  <div id="detail" role="dialog" aria-modal="true">
    <div class="sheet">
      <button class="btn close" id="btnCloseDetail">Close</button>
      <div class="l"><img id="detailImg" alt=""></div>
      <div class="r">
        <div id="topPills" class="tagrow" style="margin:2px 0 6px;gap:12px">
          <div class="pill price"><span class="aed-icon"></span><span id="dPrice">—</span></div>
          <div class="pill"><b>UPC:</b>&nbsp;<span id="dUpc">—</span></div>
        </div>

        <div class="title-row">
          <div class="title" id="dTitle">—</div>
          <div class="pill-demo" id="dDemo" style="display:none"></div>
        </div>

        <div class="panel">
          <h3>Description</h3>
          <div id="dDesc" class="muted">—</div>
        </div>

        <div class="panel" id="featBox" style="display:none">
          <h3>Key Features</h3>
          <ul id="dFeatures" class="list"></ul>
        </div>

        <div class="panel" id="incBox" style="display:none">
          <h3>What's Included</h3>
          <ul id="dIncluded" class="list"></ul>
        </div>

        <div class="panel" id="exBox" style="display:none">
          <h3>What's NOT Included</h3>
          <ul id="dExcluded" class="list"></ul>
        </div>

        <div class="panel">
          <h3>Quick Specs</h3>
          <table class="specs" id="dQuick"></table>
        </div>
      </div>
    </div>
  </div>

  <!-- compare modal -->
  <div id="compare" role="dialog" aria-modal="true" style="display:none;">
    <div class="sheet" style="display:block; max-height:92vh; overflow:auto;">
      <div style="position:sticky;top:0;z-index:2;background:#07171b;display:flex;align-items:center;justify-content:space-between;padding:10px;border-bottom:1px solid var(--glass-brd)">
        <div style="font-weight:900;letter-spacing:.4px">Compare (<span id="cmpHdrNum">0</span>)</div>
        <div style="display:flex;gap:8px">
          <button class="btn" id="cmpClose">Close</button>
        </div>
      </div>
      <div id="cmpCols"></div>
    </div>
  </div>

<script>
/* ===== Utils ===== */
const $ = s => document.querySelector(s);
const formatAED = v => {
  if(v==null || isNaN(+v)) return '—';
  const n = Number(v).toLocaleString('en-AE', {minimumFractionDigits:2, maximumFractionDigits:2});
  return n;
};
const escapeHTML = s => (s==null?'':String(s)).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));

const state = {
  rows: [],
  byId: new Map(),
  compare: new Set(),
  filters: new Set()
};

/* ===== Supabase fetch ===== */
async function fetchRows(){
  const { SUPABASE_URL, SUPABASE_ANON_KEY } = window.ENV || {};
  const url = `${SUPABASE_URL}/rest/v1/drum_kits?select=id,name,description,price,upc,upc_code,is_active,slug,category,primary_image_url,detail_image_url,on_demo,on_demo_label,features,contents,specs,kits_factory,kits_user,sounds,mesh,usb_midi,bluetooth_audio,toms_count,crash_count,ride_zones,kick_tower`;
  const res = await fetch(url, { headers: { apikey: SUPABASE_ANON_KEY, Authorization: `Bearer ${SUPABASE_ANON_KEY}` }});
  if(!res.ok){
    $('#grid').innerHTML = `<div class="pad">Could not load data (HTTP ${res.status}). Check /public/env.js anon key & RLS.</div>`;
    return [];
  }
  const rows = await res.json();
  rows.forEach(r=>{
    // category fallback
    if(!r.category){
      const hay = `${r.slug||''} ${r.name||''}`;
      if(/\bamp\b|amplif|monitor/i.test(hay)) r.category='Drum Amplification';
      else if(/samplepad|strike multipad|sr-?1?8|drum machine/i.test(hay)) r.category='Multipads & Drum Machines';
      else if(/headphone|clamp|expansion|pack|accessor/i.test(hay)) r.category='Accessories';
      else r.category='Drum Kits';
    }
  });
  return rows;
}

/* ===== Quick spec resolver ===== */
function quickRows(r){
  const q = r?.specs?.quick;
  const d = r?.specs?.data || {};
  const row = (k,v)=>`<tr><td>${escapeHTML(k)}</td><td>${escapeHTML(v==null?'-':v)}</td></tr>`;

  if(Array.isArray(q) && q.length){
    return q.map(it=>{
      const label = it.label || it.key || '';
      let v = it.value;
      if(v==null && it.key){
        let raw = (r[it.key] !== undefined ? r[it.key] : d[it.key]);
        v = (it.format==='yesno') ? (raw ? 'Yes' : 'No') : (raw ?? '-');
      }
      return row(label, v);
    }).join('');
  }

  // fallbacks by category
  const cat = r.category || '';
  if(/Drum Kits/i.test(cat)){
    const m = key => (r[key]!==undefined ? r[key] : d[key]);
    return [
      row('Category','Drum Kits'),
      row('Mesh', m('mesh') ? 'Yes' : 'No'),
      row('USB/MIDI', m('usb_midi') ? 'Yes' : 'No'),
      row('Bluetooth', m('bluetooth_audio') ? 'Yes' : 'No'),
      row('Factory kits', m('kits_factory')),
      row('User kits', m('kits_user')),
      row('Sounds', m('sounds')),
      row('Toms', m('toms_count')),
      row('Crash cymbals', m('crash_count')),
      row('Ride zones', m('ride_zones')),
      row('Kick tower', m('kick_tower') ? 'Yes' : 'No'),
      d.dimensions_cm ? row('Dimensions', d.dimensions_cm) : '',
      d.weight_kg ? row('Weight', `${d.weight_kg} kg`) : ''
    ].join('');
  }

  if(/Amplification|Amp|Monitor/i.test(cat)){
    const power = d.watt_rms ? `${d.watt_rms} W RMS${d.watt_peak?` / ${d.watt_peak} W peak`:''}` : (d.watt_peak ? `${d.watt_peak} W peak` : '-');
    return [
      row('Category','Drum Amplification'),
      d.woofer_in ? row('Woofer', `${d.woofer_in}"`) : '',
      row('Power', power),
      d.max_spl_db ? row('Max SPL', `${d.max_spl_db} dB`) : '',
      (d.freq_low_hz && d.freq_high_hz) ? row('Freq. Response', `${d.freq_low_hz} Hz – ${d.freq_high_hz} Hz`) : '',
      row('Bluetooth', (r.bluetooth_audio || d.bluetooth_version) ? 'Yes' : 'No'),
      row('Inputs', d.inputs || d.amp_inputs || '-'),
      d.outputs ? row('Outputs', d.outputs) : '',
      d.dimensions_mm ? row('Dimensions', `${d.dimensions_mm} mm`) : '',
      d.weight_kg ? row('Weight', `${d.weight_kg} kg`) : ''
    ].join('');
  }

  // generic
  return row('Category', r.category||'-');
}

/* ===== Render ===== */
function chip(label, pred){
  const btn=document.createElement('button');
  btn.className='chip';
  btn.textContent=label;
  btn.setAttribute('aria-pressed', state.filters.has(label));
  btn.onclick=()=>{
    if(state.filters.has(label)) state.filters.delete(label); else state.filters.add(label);
    btn.setAttribute('aria-pressed', state.filters.has(label));
    render();
  };
  btn._pred=pred;
  return btn;
}

function wireChips(){
  const host = $('#chips'); host.innerHTML='';
  const cs = [
    ['All', ()=>true],
    ['Drum Kits', r=>/Drum Kits/i.test(r.category)],
    ['Drum Amplification', r=>/Amplification|Amp|Monitor/i.test(r.category)],
    ['Multipads & Drum Machines', r=>/Multipads|Machine/i.test(r.category)],
    ['Accessories', r=>/Accessories/i.test(r.category)]
  ];
  cs.forEach(([lbl])=> state.filters.delete(lbl)); // reset
  cs.forEach(([lbl,p])=> host.appendChild(chip(lbl,p)));
  // default "All" selected UI-wise but we allow empty set = all
}

function AEDpill(v){
  return `<div class="pill price"><span class="aed-icon"></span>${formatAED(v)}</div>`;
}

function render(){
  const active = [...document.querySelectorAll('#chips .chip[aria-pressed="true"]')];
  const preds = active.length ? active.map(c=>c._pred) : [()=>true];

  const rows = state.rows.filter(r=>preds.some(p=>p(r)));
  const html = rows.map(r=>{
    const upc = r.upc_code || r.upc || '—';
    const chips = [];
    if(r.mesh) chips.push('Mesh');
    if(r.usb_midi) chips.push('USB/MIDI');
    if(r.bluetooth_audio) chips.push('Bluetooth');

    return `
      <div class="card" data-id="${r.id}">
        <img class="img" src="${escapeHTML(r.primary_image_url || r.detail_image_url || '')}" alt="">
        <div class="pad">
          ${AEDpill(r.price)}
          <div class="title">${escapeHTML(r.name||'')}</div>
          <div class="sub">UPC: ${escapeHTML(upc)}</div>
          <div class="tagrow">${chips.map(t=>`<div class="tag">${t}</div>`).join('')}</div>
        </div>

        <div class="cmpCtl" onclick="event.stopPropagation()">
          <input type="checkbox" ${state.compare.has(r.id)?'checked':''} data-cmp="${r.id}" id="cmp-${r.id}">
          <label for="cmp-${r.id}">Add to compare</label>
        </div>
      </div>
    `;
  }).join('');
  $('#grid').innerHTML = html;

  // click to open detail
  document.querySelectorAll('.card').forEach(el=>{
    el.addEventListener('click', e=>{
      const id = el.getAttribute('data-id');
      const r = state.byId.get(id);
      openDetail(r);
    });
  });

  // compare toggles
  document.querySelectorAll('[data-cmp]').forEach(inp=>{
    inp.addEventListener('change', e=>{
      const id = inp.getAttribute('data-cmp');
      if(inp.checked) state.compare.add(id); else state.compare.delete(id);
      updateCompareBadges();
    });
  });

  updateCompareBadges();
}

function updateCompareBadges(){
  const n = state.compare.size;
  $('#cmpCount').textContent = n;
  $('#fabCount').textContent = n;
  $('#cmpHdrNum') && ($('#cmpHdrNum').textContent = n);
  $('#compareFab').style.display = n ? 'flex' : 'none';
}

/* ===== Detail modal ===== */
function openDetail(r){
  if(!r) return;
  const root = $('#detail');
  $('#detailImg').src = r.detail_image_url || r.primary_image_url || '';
  $('#dTitle').textContent = r.name || '';
  $('#dDesc').textContent = r.description || '—';
  $('#dPrice').textContent = formatAED(r.price);
  $('#dUpc').textContent = r.upc_code || r.upc || '—';

  // demo chip logic
  const label = r.on_demo_label || (r.on_demo ? 'Play this kit on demo' : '');
  if(label){ const el = $('#dDemo'); el.style.display='inline-flex'; el.textContent = label; } else { $('#dDemo').style.display='none'; }

  // features / contents
  const F = (arr,id,boxId)=>{
    if(Array.isArray(arr) && arr.length){
      $(id).innerHTML = arr.map(x=>`<li>${escapeHTML(x)}</li>`).join('');
      $(boxId).style.display='block';
    } else $(boxId).style.display='none';
  };
  F(r.features,'#dFeatures','#featBox');
  F(r.contents,'#dIncluded','#incBox');

  // not included from specs.not_included
  const NI = r?.specs?.not_included;
  F(Array.isArray(NI)?NI:null,'#dExcluded','#exBox');

  // quick specs
  $('#dQuick').innerHTML = quickRows(r);

  root.style.display = 'grid';
}
function closeDetail(){ $('#detail').style.display='none'; }

/* ===== Compare ===== */
function openCompare(){
  const ids=[...state.compare];
  const rows=ids.map(id=>state.byId.get(id)).filter(Boolean);
  const cols = rows.map(r=>`
    <div class="col">
      <div class="head">
        <div style="font-weight:900">${escapeHTML(r.name||'')}</div>
        ${AEDpill(r.price)}
      </div>
      <div class="pad">
        <table class="specs">${quickRows(r)}</table>
        <div style="display:flex;gap:8px;margin-top:10px">
          <button class="btn" onclick="removeFromCompare('${r.id}')">Remove</button>
        </div>
      </div>
    </div>
  `).join('');
  $('#cmpCols').innerHTML = cols || `<div class="pad">Nothing to compare yet.</div>`;
  $('#compare').style.display='grid';
}
function closeCompare(){ $('#compare').style.display='none'; }
function removeFromCompare(id){ state.compare.delete(String(id)); updateCompareBadges(); openCompare(); }

/* ===== Wiring ===== */
$('#btnCompare').onclick = openCompare;
$('#compareFab').onclick = openCompare;
$('#cmpClose').onclick = closeCompare;
$('#btnCloseDetail').onclick = closeDetail;

// click outside sheet to close
['detail','compare'].forEach(id=>{
  document.getElementById(id).addEventListener('click', e=>{
    if(e.target.id===id) document.getElementById(id).style.display='none';
  });
});

// tag demo chips in the detail (safety if content changes)
new MutationObserver(()=> {
  document.querySelectorAll('#detail .pill, #detail .chip').forEach(el=>{
    const t=(el.textContent||'').toLowerCase();
    if(t.includes('demo')) el.classList.add('pill-demo');
  });
}).observe(document.body,{subtree:true, childList:true});

/* ===== Boot ===== */
(async ()=>{
  wireChips();
  state.rows = await fetchRows();
  state.byId = new Map(state.rows.map(r=>[String(r.id), r]));
  render();
})();
</script>
</body>
</html>
