<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Alesis Soundstage</title>

<!-- Theme: keep the black + fluoro glass look -->
<style>
  :root{
    --bg:#0b0f13;
    --panel:#0f141a;
    --glass:rgba(15,21,27,.72);
    --glass-brd:rgba(55,137,153,.35);
    --chip:#0d2e35;
    --chip-brd:#12434d;
    --pill:#00c7d8;
    --pill-text:#002326;
    --text:#e9f7ff;
    --muted:#a7bdc5;
    --line:rgba(86,150,160,.35);
  }
  html,body{height:100%}
  body{
    margin:0; color:var(--text); background:var(--bg);
    font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif;
    -webkit-font-smoothing:antialiased;
    background-image:
      radial-gradient(800px 520px at 20% 12%, rgba(0,209,234,.08) 0,transparent 62%),
      radial-gradient(800px 520px at 88% 8%, rgba(0,209,234,.07) 0,transparent 60%);
  }
  .wrap{max-width:1160px; margin:0 auto; padding:14px 16px 28px}
  .bar{position:sticky; top:0; z-index:30; backdrop-filter:saturate(120%) blur(6px);
       display:flex; align-items:center; gap:10px; padding:12px 10px;
       background:linear-gradient(180deg, rgba(11,15,19,.92), rgba(11,15,19,.65));
       border-bottom:1px solid var(--glass-brd); margin:-14px -16px 12px; }
  .crumbs{font-weight:800; letter-spacing:.3px}
  .crumbs .tag{display:inline-block; padding:3px 8px; border-radius:999px; margin-left:6px;
    background:#06323a; color:#76f7ff; font-size:12px; border:1px solid var(--glass-brd)}
  .grow{flex:1}
  .btn{appearance:none; border:1px solid var(--glass-brd); background:var(--glass); color:var(--text);
    padding:10px 14px; border-radius:12px; font-weight:650; cursor:pointer}
  .btn:hover{border-color:#3adcf0}
  .btn-primary{background:#ff2b2b; border-color:#ff2b2b}
  .btn-ghost{background:transparent}

  #chips{display:flex; gap:10px; flex-wrap:wrap; margin:12px 0 10px}
  .chip{border:1px solid var(--glass-brd); background:var(--panel); color:#cdeef2;
    padding:8px 12px; border-radius:999px; cursor:pointer; user-select:none; white-space:nowrap}
  .chip.active{background:#0b2c34; border-color:#1db8c4}
  .chip.demo{font-size:12px; padding:4px 10px; border-radius:999px}

  #grid{display:grid; gap:14px; grid-template-columns:repeat(auto-fill,minmax(280px,1fr))}
  .card{background:var(--glass); border:1px solid var(--glass-brd); border-radius:16px; overflow:hidden}
  .imgbox{position:relative; height:200px; background:#0b0e12; cursor:pointer}
  .imgbox img{width:100%; height:100%; object-fit:cover; display:block}
  .demo{position:absolute; top:10px; left:10px; background:#ffd400; color:#231a00; font-weight:800;
    border-radius:999px; padding:6px 10px; box-shadow:0 10px 24px rgba(0,0,0,.35)}
  .content{padding:12px 12px 14px}
  .title{font-weight:800; margin:6px 0 8px; cursor:pointer}
  .pill{display:inline-block; background:var(--pill); color:var(--pill-text);
    border-radius:999px; padding:6px 12px; font-weight:800}

  /* Detail modal */
  dialog{border:1px solid var(--glass-brd); border-radius:18px; padding:0; background:rgba(10,14,18,.96);
    color:var(--text); width:min(1060px,96vw)}
  dialog::backdrop{background:rgba(0,0,0,.6)}
  .sheet{display:grid; grid-template-columns:1.1fr 1fr; gap:16px; padding:14px}
  .left{background:var(--panel); border:1px solid var(--glass-brd); border-radius:16px; padding:12px}
  .left .imgwrap{background:#fff; border-radius:12px; overflow:hidden; height:min(58vh,520px)}
  .left .imgwrap img{width:100%; height:100%; object-fit:contain; display:block}
  .right .chiprow{display:flex; gap:8px; align-items:center; margin-bottom:10px; flex-wrap:wrap}
  .chip.price{background:#0b3f45; border:1px solid #125056}
  .chip.upc{background:#052d33; border:1px solid #0f4950}
  .section{border:1px solid var(--glass-brd); border-radius:12px; padding:12px; margin-top:12px;
    background:rgba(7,12,16,.66)}
  .section h4{margin:0 0 8px; font-size:16px; font-weight:800; color:#fff}
  .section p,.section li,.section div{color:#fff}
  .section ul{list-style:disc; padding-left:18px; margin:0}
  .section li::marker{color:#26e3ff}

  /* Compare dialog */
  #cmp{width:min(1100px,96vw)}
  #cmp .cols{display:grid; gap:14px; grid-template-columns:repeat(auto-fit,minmax(320px,1fr));
             padding:12px}
  #cmp .col{background:var(--glass); border:1px solid var(--glass-brd); border-radius:14px; overflow:hidden}
  #cmp .col .pad{padding:12px}
  #cmp .specs{width:100%; border-collapse:collapse; margin-top:8px}
  #cmp .specs td{border-bottom:1px dotted var(--line); padding:8px 6px}
  #cmp .specs td:first-child{color:#bfefff}
  #ladder{border-top:1px solid var(--glass-brd); margin:6px 12px 12px; padding-top:12px}
  #ladder .row{display:flex; flex-wrap:wrap; gap:8px; align-items:center}
  #ladder .pill{display:inline-block; font-size:12px; padding:4px 10px; border-radius:18px}

  /* Mobile tweaks */
  @media (max-width:900px){
    .sheet{grid-template-columns:1fr}
    .left .imgwrap{height:44vh}
    #cmp .cols{grid-auto-flow:column; grid-template-columns:repeat(auto-fit, 88vw);
               overflow-x:auto; overflow-y:hidden; scroll-snap-type:x mandatory; -webkit-overflow-scrolling:touch}
    #cmp .col{scroll-snap-align:start}
  }

  /* Floating Compare FAB */
  #compareFab{
    position:fixed; right:14px; bottom:14px; z-index:40; display:none;
    padding:12px 16px; border-radius:999px; background:#0c2b31; border:1px solid #17535c; color:#cdeef2;
    box-shadow:0 10px 24px rgba(0,0,0,.35); cursor:pointer; font-weight:800;
  }
  #compareFab .count{
    display:inline-block; margin-left:8px; padding:4px 10px; border-radius:999px;
    background:var(--pill); color:var(--pill-text); font-weight:900;
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="bar">
      <div class="crumbs">ALESIS <span class="tag">DRUMS</span></div>
      <div class="grow"></div>
      <button id="btnCompare" class="btn">Compare <span id="cmpCount">0</span></button>
      <button id="btnWizard" class="btn btn-primary">Find my kit</button>
    </div>

    <h2 style="margin:6px 0 6px">Electronic Drum Range</h2>
    <div class="muted">Compare features and choose the perfect Alesis kit for practice, recording, or performance.</div>

    <div id="chips"></div>
    <div id="grid"></div>
  </div>

  <!-- Floating Compare button -->
  <button id="compareFab">Compare <span class="count" id="fabCount">0</span></button>

  <!-- Detail modal -->
  <dialog id="detail">
    <div class="sheet">
      <div class="left">
        <div class="imgwrap"><img id="dimg" alt=""></div>
      </div>
      <div class="right">
        <div class="chiprow">
          <span id="dprice" class="chip price">AED —</span>
          <span id="dupc" class="chip upc" style="display:none"></span>
          <span id="ddemo" class="chip demo" style="display:none;background:#ffd400;color:#231a00;font-weight:800"></span>
        </div>
        <div id="dname" style="font-weight:900; font-size:18px; margin:2px 0 8px"></div>

        <div class="section">
          <h4>Description</h4>
          <div id="ddesc" class="muted">—</div>
        </div>
        <div class="section">
          <h4>Key Features</h4>
          <ul id="dfeat"></ul>
        </div>
        <div class="section">
          <h4>What's Included</h4>
          <ul id="dinc"></ul>
        </div>
        <div class="section" id="dni" style="display:none">
          <h4>What's NOT Included</h4>
          <ul id="dnot"></ul>
        </div>
        <div class="section">
          <h4>Quick Specs</h4>
          <table class="specs" id="dspec"></table>
        </div>
        <div style="margin-top:10px">
          <button class="btn btn-ghost" data-close>Close</button>
        </div>
      </div>
    </div>
  </dialog>

  <!-- Compare -->
  <dialog id="cmp">
    <div class="bar" style="padding:10px 12px 0; margin:0; position:sticky; top:0; background:rgba(11,15,19,.96)">
      <div style="font-weight:900">Compare</div>
      <div class="grow"></div>
      <button class="btn btn-ghost" data-close>Close</button>
    </div>
    <div class="cols" id="cmpCols"></div>
    <div id="ladder"></div>
  </dialog>

  <!-- Find My Kit -->
  <dialog id="wizard">
    <div class="bar" style="padding:10px 12px 0; margin:0; position:sticky; top:0; background:rgba(11,15,19,.96)">
      <div style="font-weight:900">Find My Perfect Kit</div>
      <div class="grow"></div>
      <button class="btn btn-ghost" data-close>Close</button>
    </div>
    <div style="padding:12px">
      <div style="display:grid; gap:10px; grid-template-columns:repeat(auto-fit,minmax(220px,1fr))">
        <label>Experience
          <select id="wExp" class="btn" style="display:block;width:100%;margin-top:6px">
            <option>Beginner</option><option>Intermediate</option><option>Advanced</option>
          </select>
        </label>
        <label>Budget
          <select id="wBud" class="btn" style="display:block;width:100%;margin-top:6px">
            <option value="0-2000">AED 0 – 2,000</option>
            <option value="2000-5000" selected>AED 2,000 – 5,000</option>
            <option value="5000-15000">AED 5,000 – 15,000</option>
          </select>
        </label>
        <label>Goal
          <select id="wGoal" class="btn" style="display:block;width:100%;margin-top:6px">
            <option>Learning</option><option>Recording</option><option>Live</option>
          </select>
        </label>
        <label>Connectivity
          <select id="wConn" class="btn" style="display:block;width:100%;margin-top:6px">
            <option>USB/MIDI</option><option>Bluetooth</option><option>No preference</option>
          </select>
        </label>
      </div>
      <div style="margin-top:12px">
        <button id="wGo" class="btn btn-primary">Get Recommendation</button>
      </div>
      <div id="wizOut" style="margin-top:14px"></div>
    </div>
  </dialog>

  <!-- ENV (expects window.ENV from /env.js with SUPABASE_URL + SUPABASE_ANON_KEY) -->
  <script src="/env.js"></script>

  <script>
    /* ===== helpers ===== */
    const $  = (s,el=document)=>el.querySelector(s);
    const $$ = (s,el=document)=>Array.from(el.querySelectorAll(s));
    const AED = v => (v==null||v==='') ? 'AED —' :
      new Intl.NumberFormat('en-AE',{style:'currency',currency:'AED',maximumFractionDigits:2}).format(+v);

    const PLACEHOLDER = 'data:image/svg+xml;utf8,'+encodeURIComponent(
      '<svg xmlns="http://www.w3.org/2000/svg" width="640" height="400"><rect width="100%" height="100%" fill="#f4f6f8"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="system-ui,Segoe UI,Arial" font-size="22">Image coming soon</text></svg>'
    );

    function getUPC(r){ return r.upc_code || r.upc || r.ean || r.barcode || null; }
    function pickImage(r,kind='card'){
      const direct = (kind==='detail' && r.detail_image_url) || r.primary_image_url || r.image_url;
      return direct || PLACEHOLDER;
    }
    function canonicalCategory(raw){
      if (!raw) return 'Drum Kits';
      const c = (raw.category || raw._cat || '').toLowerCase();
      if (c.includes('ampl')) return 'Drum Amplification';
      if (c.includes('multi') || c.includes('samplepad') || c.includes('drum machine')) return 'Multipads & Drum Machines';
      if (c.includes('access')) return 'Accessories';
      return 'Drum Kits';
    }
    function deriveCategory(r){
      if (r.category) return canonicalCategory(r);
      const s = `${r.slug||''} ${r.name||''}`.toLowerCase();
      if (s.match(/\bamp\b|amplif|monitor/)) return 'Drum Amplification';
      if (s.match(/samplepad|strike multipad|sr-?1?6|sr-?1?8|drum machine/)) return 'Multipads & Drum Machines';
      if (s.match(/headphone|clamp|expansion|pack|accessor/)) return 'Accessories';
      return 'Drum Kits';
    }

    const state = { rows:[], byId:new Map(), compare:new Set(), filterLabel:'All' };

    /* ===== fetch data ===== */
    async function load(){
      const url = `${window.ENV.SUPABASE_URL}/rest/v1/drum_kits?select=`+
        [
          'id,name,description,price,upc,upc_code,is_active,slug,category',
          'primary_image_url,detail_image_url,on_demo,on_demo_label',
          'features,contents,specs',
          'module_engine,kits_factory,kits_user,sounds,module_touchscreen_in',
          'snare_in,snare_zones,toms_count,toms_sizes_in,kick_tower,hihat_in,crash_count,ride_zones',
          'bluetooth_audio,usb_midi,mesh,pieces,watt_peak'
        ].join(',');
      const headers={apikey:window.ENV.SUPABASE_ANON_KEY, Authorization:`Bearer ${window.ENV.SUPABASE_ANON_KEY}`};
      const res = await fetch(url,{headers});
      const rows = await res.json();
      rows.forEach(r=>r._cat = deriveCategory(r));
      state.rows = rows;
      state.byId = new Map(rows.map(r=>[String(r.id),r]));
      wireChips();
      render();
      updateFab(); // set initial FAB visibility
    }

    /* ===== chips / filters ===== */
    function wireChips(){
      const labels = ['All','Electronic Drum Kits','Multipads & Drum Machines','Drum Amplification','Accessories','On Demo'];
      $('#chips').innerHTML = labels.map(l=>`<div class="chip${state.filterLabel===l?' active':''}" data-filter="${l}">${l}</div>`).join('');
      $('#chips').addEventListener('click',e=>{
        const b=e.target.closest('.chip'); if(!b) return;
        $$('#chips .chip').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        state.filterLabel=b.dataset.filter;
        render();
      });
    }
    function fitsFilter(r){
      const c = state.filterLabel;
      if (c==='All') return true;
      if (c==='On Demo') return !!r.on_demo;
      if (c==='Electronic Drum Kits') return deriveCategory(r)==='Drum Kits';
      return deriveCategory(r)===c;
    }

    /* ===== render grid ===== */
    function render(){
      document.getElementById('cmpCount').textContent = state.compare.size;
      const grid = $('#grid');
      const shown = state.rows.filter(fitsFilter);
      if (!shown.length){ grid.innerHTML = '<div class="muted">No items match this view.</div>'; return; }
      grid.innerHTML = shown.map(r=>{
        const demo = r.on_demo ? `<div class="demo">`+(r.on_demo_label||'On Demo')+`</div>` : '';
        const pills = [];
        if (r.mesh) pills.push('Mesh');
        if (r.usb_midi) pills.push('USB/MIDI');
        if (r.bluetooth_audio) pills.push('Bluetooth');
        const upc = getUPC(r);
        return `
          <div class="card" data-id="${r.id}">
            <div class="imgbox" data-open>
              ${demo}
              <img src="${pickImage(r,'card')}" alt="">
            </div>
            <div class="content">
              <div class="pill">${AED(r.price)}</div>
              <div class="title" data-open>${r.name||''}</div>
              ${upc?`<div class="muted" style="margin-bottom:8px">UPC: ${upc}</div>`:''}
              <div style="display:flex; gap:6px; flex-wrap:wrap; margin:6px 0">
                ${pills.map(p=>`<span class="chip" style="background:#082b33;border-color:#11424a">${p}</span>`).join('')}
              </div>
              <div style="display:flex; gap:8px; align-items:center; margin-top:4px">
                <button class="btn btn-ghost" data-explore>Explore</button>
                <label class="muted" style="display:flex; align-items:center; gap:8px">
                  <input type="checkbox" data-compare ${state.compare.has(String(r.id))?'checked':''}> Add to compare
                </label>
              </div>
            </div>
          </div>`;
      }).join('');

      // wire cards
      $$('#grid .card').forEach(card=>{
        card.querySelectorAll('[data-open]').forEach(n=>n.addEventListener('click',()=>openDetail(card.dataset.id)));
        card.querySelector('[data-explore]').addEventListener('click',()=>openDetail(card.dataset.id));
        card.querySelector('[data-compare]').addEventListener('change',(e)=>{
          const id = String(card.dataset.id);
          if (e.currentTarget.checked) state.compare.add(id); else state.compare.delete(id);
          document.getElementById('cmpCount').textContent = state.compare.size;
          document.getElementById('fabCount').textContent = state.compare.size;
          updateFab();
        });
      });
    }

    /* ===== Quick specs (category-aware; pulls from Supabase fields + specs JSON) ===== */
    function rowsFromSpecs(r){
      const cat = deriveCategory(r);
      const J = r.specs || {};
      const yes = v => v ? 'Yes' : 'No';
      const rows = [];

      if (cat==='Drum Kits'){
        rows.push(['Pieces', r.pieces]);
        rows.push(['Mesh heads', yes(!!r.mesh)]);
        rows.push(['Factory kits', r.kits_factory]);
        rows.push(['User kits', r.kits_user]);
        rows.push(['Sounds', r.sounds]);
        rows.push(['USB/MIDI', yes(!!r.usb_midi)]);
        rows.push(['Bluetooth audio', yes(!!r.bluetooth_audio)]);
        rows.push(['Toms', r.toms_count]);
        rows.push(['Crash cymbals', r.crash_count]);
        rows.push(['Ride zones', r.ride_zones]);
        rows.push(['Kick tower', yes(!!r.kick_tower)]);
      }else if (cat==='Drum Amplification'){
        rows.push(['Peak power (W)', r.watt_peak || J.watt_peak]);
        rows.push(['Bluetooth', yes(!!r.bluetooth_audio)]);
        rows.push(['Inputs', J.inputs || J.input || '2× XLR/TRS']);
        rows.push(['Outputs', J.outputs || (J.xlr_out ? 'XLR Out' : '—')]);
        rows.push(['EQ / HPF', J.eq || J.hpf || (J.contour?'Contour':'—')]);
      }else if (cat==='Multipads & Drum Machines'){
        rows.push(['USB/MIDI', yes(!!r.usb_midi)]);
        rows.push(['Bluetooth', yes(!!r.bluetooth_audio)]);
        rows.push(['Factory kits', r.kits_factory || J.kits]);
        rows.push(['Sounds', r.sounds || J.sounds]);
        rows.push(['Inputs', J.inputs || J.trigger_inputs]);
      }else if (cat==='Accessories'){
        rows.push(['Type', J.type || (/headphone/i.test(r.name||'')?'Headphones':/clamp|mount/i.test(r.name||'')?'Mount/Clamp':'Accessory')]);
        if (J.drivers) rows.push(['Drivers', J.drivers]);
      }

      return rows.filter(([k,v]) => v!=null && v!=='' && v!=='—');
    }

    function specTableHTML(rows){
      if (!rows.length) return '<tr><td>—</td><td>—</td></tr>';
      return rows.map(([k,v])=>`<tr><td>${k}</td><td style="text-align:right">${v}</td></tr>`).join('');
    }

    /* ===== Detail modal ===== */
    function asList(node, arr){
      node.innerHTML = '';
      if (!Array.isArray(arr) || !arr.length){ node.innerHTML = '<li>—</li>'; return; }
      node.innerHTML = arr.map(x=>`<li>${String(x)}</li>`).join('');
    }

    function openDetail(id){
      const r = state.byId.get(String(id)); if(!r) return;

      // header bits
      $('#dimg').src = pickImage(r,'detail');
      $('#dname').textContent = r.name || '';
      $('#dprice').textContent = AED(r.price);
      const upc = getUPC(r);
      const upcEl = $('#dupc');
      if (upc){ upcEl.style.display='inline-block'; upcEl.textContent = `UPC: ${upc}`; } else upcEl.style.display='none';
      const dem = $('#ddemo');
      if (r.on_demo){ dem.style.display='inline-block'; dem.textContent = r.on_demo_label || 'On Demo'; }
      else dem.style.display='none';

      // sections
      $('#ddesc').textContent = r.description || '—';
      asList($('#dfeat'), r.features);
      asList($('#dinc'), r.contents);

      const notInc = (r.specs && (r.specs.not_included || r.specs.notIncluded)) || null;
      if (Array.isArray(notInc) && notInc.length){
        $('#dni').style.display='block';
        asList($('#dnot'), notInc);
      }else{
        $('#dni').style.display='none';
      }

      // quick specs
      $('#dspec').innerHTML = specTableHTML(rowsFromSpecs(r));

      const dlg = $('#detail');
      dlg.showModal();
    }

    /* ===== Compare ===== */
    function specRow(label, val){
      const v = (val===true)?'Yes' : (val===false||val==null||val==='')?'—' : val;
      return `<tr><td>${label}</td><td style="text-align:right">${v}</td></tr>`;
    }

    function featureDiffWhy(base, better){
      const out = [];
      const gt = (a,b,k,label)=>{ const av=+a[k]||0, bv=+b[k]||0; if (bv>av) out.push(`more ${label} (${av} → ${bv})`); };
      const flag = (a,b,k,label)=>{ if ((b[k]&& !a[k])) out.push(label); };

      gt(base,better,'kits_factory','factory kits');
      gt(base,better,'kits_user','user kits');
      gt(base,better,'sounds','sounds');
      gt(base,better,'toms_count','toms');
      gt(base,better,'crash_count','crash cymbals');
      gt(base,better,'ride_zones','ride zones');
      if ((better.mesh||0) && !base.mesh) out.push('mesh heads');
      flag(base,better,'bluetooth_audio','Bluetooth audio');
      flag(base,better,'usb_midi','USB/MIDI');
      if ((+better.watt_peak||0) > (+base.watt_peak||0)) out.push(`more power (${base.watt_peak||0}W → ${better.watt_peak}W)`);
      return out;
    }

    function openCompare(){
      const ids = Array.from(state.compare);
      const rows = ids.map(id=>state.byId.get(String(id))).filter(Boolean);
      const cols = $('#cmpCols');
      if (!rows.length){ cols.innerHTML = '<div class="muted" style="padding:10px">No items selected.</div>'; }
      else{
        cols.innerHTML = rows.map(r=>{
          return `
            <div class="col" data-id="${r.id}">
              <div class="pad">
                <div class="pill">${AED(r.price)}</div>
                <div class="title" style="margin-top:6px">${r.name||''}</div>
                <table class="specs">
                  ${specRow('Category', deriveCategory(r))}
                  ${specRow('On Demo', r.on_demo ? 'Yes':'No')}
                  ${specRow('USB/MIDI', r.usb_midi ? 'Yes':'No')}
                  ${specRow('Bluetooth', r.bluetooth_audio ? 'Yes':'No')}
                  ${specRow('Factory kits', r.kits_factory)}
                  ${specRow('User kits', r.kits_user)}
                  ${specRow('Sounds', r.sounds)}
                  ${specRow('Toms', r.toms_count)}
                  ${specRow('Crash cymbals', r.crash_count)}
                  ${specRow('Ride zones', r.ride_zones)}
                  ${specRow('Kick tower', r.kick_tower ? 'Yes':'No')}
                </table>
                <div style="display:flex; gap:8px; margin-top:10px">
                  <button class="btn btn-ghost" data-open>Explore</button>
                  <button class="btn btn-ghost" data-remove>Remove</button>
                </div>
              </div>
            </div>`;
        }).join('');

        // wire buttons
        $$('#cmpCols .col').forEach(col=>{
          col.querySelector('[data-open]').addEventListener('click',()=>{ $('#cmp').close(); openDetail(col.dataset.id); });
          col.querySelector('[data-remove]').addEventListener('click',()=>{
            state.compare.delete(String(col.dataset.id));
            document.getElementById('cmpCount').textContent = state.compare.size;
            document.getElementById('fabCount').textContent = state.compare.size;
            openCompare();
          });
        });
      }

      // Recommendation Ladder
      const ladder = $('#ladder');
      if (rows.length>=2){
        const sorted = rows.slice().sort((a,b)=>(+a.price)-(+b.price));
        const base = sorted[0], better = sorted[sorted.length-1];
        const diff = Math.max(0,(+better.price)-(+base.price));
        const pct = base.price ? Math.round((diff/base.price)*100) : 0;
        const reasons = featureDiffWhy(base, better);
        ladder.innerHTML = `
          <div class="section">
            <div style="font-weight:900; color:#7ff5ff; margin-bottom:6px">Recommendation Ladder</div>
            <div class="row" style="margin-bottom:6px">
              <span class="chip" style="background:#062f36;border:1px solid #0f4950">Baseline</span>
              <b>${base.name}</b> — ${AED(base.price)}
            </div>
            <div class="row" style="margin-bottom:6px">
              <span class="chip" style="background:#062f36;border:1px solid #0f4950">Jump to</span>
              <b>${better.name}</b> — ${AED(better.price)}
              <span class="chip" style="background:#143a42;border:1px solid #1a4f59; margin-left:6px">+${AED(diff)} (${pct}%)</span>
            </div>
            <div class="muted">Why: ${reasons.length ? reasons.join(', ') : 'overall higher spec'}.</div>
          </div>`;
      }else{
        ladder.innerHTML = '';
      }

      const dlg = $('#cmp');
      dlg.showModal();
    }

    /* ===== Wizard ===== */
    function openWizard(){
      const dlg = $('#wizard');
      const out = $('#wizOut');
      out.textContent = '';
      dlg.showModal();
      $('#wGo').onclick=()=>{
        const [lo,hi] = $('#wBud').value.split('-').map(Number);
        const conn = $('#wConn').value;
        const choices = state.rows.filter(r=>{
          const p = +r.price || 0;
          if (p<lo || p>hi) return false;
          if (conn==='USB/MIDI' && !r.usb_midi) return false;
          if (conn==='Bluetooth' && !r.bluetooth_audio) return false;
          return deriveCategory(r)==='Drum Kits';
        }).sort((a,b)=>(+a.price)-(+b.price));

        if (!choices.length){ out.innerHTML = '<div class="muted">No kit matches your preferences.</div>'; return; }
        const top = choices[Math.min(1, choices.length-1)];
        const msg = `Because it matches your budget, ${conn==='No preference'?'your needs':'your connectivity preference'}, and offers ${top.mesh?'mesh heads':'a solid starter spec'}.`;
        out.innerHTML = `
          <div class="section">
            <div style="font-weight:900; color:#9ff8ff">Your Match</div>
            <div style="margin:6px 0"><b>${top.name}</b> looks like a great fit at ${AED(top.price)}.</div>
            <div class="muted">${msg}</div>
            <div style="margin-top:10px"><button class="btn btn-primary" id="wizOpen">View This Kit</button></div>
          </div>`;
        $('#wizOpen').onclick=()=>{ dlg.close(); openDetail(top.id); };
      };
    }

    /* ===== Floating Compare FAB visibility ===== */
    function updateFab(){
      const show = state.compare.size>0 && window.scrollY>120;
      const el = document.getElementById('compareFab');
      el.style.display = show ? 'block' : 'none';
      document.getElementById('fabCount').textContent = state.compare.size;
      document.getElementById('cmpCount').textContent = state.compare.size;
    }
    document.getElementById('compareFab').addEventListener('click', ()=>openCompare());
    window.addEventListener('scroll', updateFab);

    /* ===== header buttons + ESC to close dialogs ===== */
    function wireHeader(){
      $('#btnCompare').onclick=()=>openCompare();
      $('#btnWizard').onclick=()=>openWizard();
      document.addEventListener('keydown', e=>{
        if (e.key==='Escape'){
          ['detail','cmp','wizard'].forEach(id=>{ const d=document.getElementById(id); if (d && d.open) d.close(); });
        }
      });
      // Close buttons
      $$('dialog [data-close]').forEach(x=>x.addEventListener('click', e=>e.target.closest('dialog').close()));
    }

    /* ===== boot ===== */
    window.addEventListener('DOMContentLoaded', async ()=>{ wireHeader(); await load(); });
  </script>
</body>
</html>
