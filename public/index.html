<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Alesis Soundstage</title>
<style>
  :root{
    --bg:#000000; --glass:#0b1118; --blue:#00e5ff; --card:#101821; --card-b:#2b3642;
    --text:#e6eef6; --muted:#9bb0c7; --radius:14px;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0; font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--text);
    background:var(--bg);
    /* floral-blue glass glow on black */
    background-image:
      radial-gradient(1200px 600px at 80% -10%, rgba(0,229,255,.10), transparent 60%),
      radial-gradient(1000px 520px at -5% 115%, rgba(0,229,255,.08), transparent 62%);
  }
  .wrap{max-width:1200px;margin:22px auto;padding:0 16px}
  .top{display:flex;align-items:center;justify-content:space-between;gap:12px;
       padding:10px 12px;border:1px solid var(--card-b);border-radius:12px;
       background:rgba(11,17,24,.55);backdrop-filter:blur(8px)}
  .brand{display:flex;align-items:center;gap:10px}
  .pill{font-weight:800;font-size:11px;padding:4px 8px;border-radius:999px;background:#0b2b33;color:var(--blue);border:1px solid #10424b}
  .btn{appearance:none;border:1px solid var(--card-b);background:transparent;color:var(--text);padding:8px 12px;border-radius:12px;cursor:pointer}
  .btn-primary{background:var(--blue);color:#001f24;border-color:#0a6b79;font-weight:800;box-shadow:0 4px 22px rgba(0,229,255,.25)}
  .btn-counter{display:inline-flex;align-items:center;gap:8px}
  .counter{min-width:18px;height:18px;padding:0 6px;display:inline-flex;align-items:center;justify-content:center;border-radius:999px;font-size:11px;background:#0f1d24;border:1px solid #1e2c36}
  h1{margin:18px 0 6px;font-size:26px}
  .sub{color:var(--muted);margin-bottom:10px}
  .chips{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0 16px}
  .chip{background:#1b2631;border:1px solid var(--card-b);color:#cfe6f0;border-radius:999px;padding:8px 12px;cursor:pointer}
  .chip.active{background:#0c3945;color:var(--blue);border-color:#0e3e47}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
  @media (max-width:900px){.grid{grid-template-columns:repeat(2,1fr)}}
  @media (max-width:620px){.grid{grid-template-columns:1fr}}
  .card{background:rgba(11,17,24,.66);border:1px solid var(--card-b);border-radius:var(--radius);overflow:hidden}
  .imgbox{position:relative;background:#000}
  .imgbox img{width:100%;height:240px;object-fit:cover;display:block}
  .demo{position:absolute;top:10px;left:10px;background:#fde047;color:#111;border-radius:999px;padding:6px 10px;font-weight:800}
  .content{padding:10px 12px}
  .title{font-weight:800;margin:4px 0 2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .desc{color:var(--muted);font-size:12px;line-height:1.4}
  .price{display:inline-block;background:#032e36;color:var(--blue);font-weight:900;border:1px solid #0e3e47;border-radius:999px;padding:6px 9px;margin:8px 0}
  .tag{display:inline-block;background:#0c151c;color:#cfe6f0;border:1px solid #24323f;border-radius:999px;padding:4px 8px;font-size:12px;margin-right:6px;margin-top:6px}
  .line{display:flex;align-items:center;justify-content:space-between;margin-top:8px}
  .cmp{color:#a6c7d6;font-size:12px;display:flex;align-items:center;gap:8px}
  dialog{border:none;padding:0;background:transparent}
  dialog::backdrop{background:rgba(0,0,0,.65)}
  .modal{max-width:980px;margin:auto;background:rgba(11,17,24,.93);border:1px solid var(--card-b);border-radius:14px}
  .modal-head{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--card-b)}
  .x{background:#0e1b22;border:1px solid #2b3642;color:#cfe6f0;border-radius:12px;padding:6px 10px;cursor:pointer}
  .detail{display:grid;grid-template-columns:51% 49%;gap:14px;padding:14px}
  @media (max-width:820px){.detail{grid-template-columns:1fr}}
  .photo{background:#ffffff;border-radius:12px;display:flex;align-items:center;justify-content:center;padding:14px;border:1px solid #dfe7ee}
  .photo img{max-width:100%;max-height:360px;object-fit:contain;display:block}
  .sheet .chip{margin-right:8px;margin-bottom:8px}
  .sheet .chip.price{background:#032e36;border-color:#0e3e47;color:var(--blue);font-weight:900}
  .section{border:1px solid var(--card-b);border-radius:12px;padding:12px;margin-top:12px}
  .section h4{margin:0 0 6px;color:#c8d3e0}
  .section ul{margin:0;padding-left:18px}
  .section li{list-style:disc;padding:3px 0}
  .muted{color:var(--muted)}
</style>
    <link rel="stylesheet" href="/hotfix.css?v=99">
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand"><strong>ALESIS</strong><span class="pill">DRUMS</span></div>
      <div style="display:flex;gap:8px">
        <button id="btnCompare" class="btn btn-counter">Compare <span id="cmpCount" class="counter">0</span></button>
        <button id="btnWizard" class="btn btn-primary">Find my kit</button>
      </div>
    </div>

    <h1>Electronic Drum Range</h1>
    <div class="sub">Compare features and choose the perfect Alesis kit for practice, recording, or performance.</div>

    <div class="chips" id="chips"></div>
    <div class="grid" id="grid"></div>
  </div>

  <!-- Detail -->
  <dialog id="detail"><div class="modal">
    <div class="modal-head"><strong id="dTitle">Product</strong><button class="x" data-close="detail">Close</button></div>
    <div id="dBody" class="detail"></div>
  </div></dialog>

  <!-- Compare -->
  <dialog id="compare"><div class="modal">
    <div class="modal-head"><strong>Compare</strong><button class="x" data-close="compare">Close</button></div>
    <div id="cBody" style="padding:12px"></div>
  </div></dialog>

  <!-- Wizard -->
  <dialog id="wizard"><div class="modal">
    <div class="modal-head"><strong>Find My Perfect Kit</strong><button class="x" data-close="wizard">Close</button></div>
    <div style="padding:12px">
      <div class="wizard-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <label>Experience <select id="wExp"><option>Beginner</option><option selected>Intermediate</option><option>Advanced</option></select></label>
        <label>Budget <select id="wBudget">
          <option>Under AED 2000</option><option selected>AED 2000 - 5000</option><option>AED 5000 - 9000</option><option>Over AED 9000</option>
        </select></label>
        <label>Space <select id="wSpace"><option>Compact</option><option selected>Standard</option><option>Studio</option></select></label>
        <label>Goal <select id="wGoal"><option>Learning</option><option selected>Recording</option><option>Performance</option></select></label>
        <label>Noise Sensitivity <select id="wNoise"><option>High (keep it quiet)</option><option selected>Medium</option><option>Low</option></select></label>
        <label>Connectivity Preference <select id="wConn"><option>USB/MIDI</option><option>Bluetooth</option><option selected>No preference</option></select></label>
      </div>
      <div style="padding-top:10px;display:flex;gap:8px">
        <button id="wGo" class="btn btn-primary">Get Recommendation</button>
        <button class="btn" data-close="wizard">Close</button>
      </div>
      <div id="wOut" style="margin-top:12px"></div>
    </div>
  </div></dialog>

  <!-- ENV -->
  <script src="/env.js"></script>

  <!-- App -->
  <script>
  (function(){
    var $=function(s,e){return (e||document).querySelector(s)};
    var $$=function(s,e){return Array.from((e||document).querySelectorAll(s))};
    var AED=function(n){try{return new Intl.NumberFormat('en-AE',{style:'currency',currency:'AED'}).format(n||0)}catch(e){return 'AED '+(n||0)}};
    var PLACEHOLDER='data:image/svg+xml;utf8,'+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="720" height="480"><rect width="100%" height="100%" fill="#f4f6f8"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="system-ui,Segoe UI,Arial" font-size="22" fill="#8a97a6">Image coming soon</text></svg>');

    var state={rows:[],byId:new Map(),filter:'All',compare:new Set()};
    var CHIPS=['All','Electronic Drum Kits','Multipads & Drum Machines','Drum Amplification','Accessories','On Demo'];
    var MAP={'Electronic Drum Kits':'Drum Kits','Drum Amplification':'Drum Amps','Multipads & Drum Machines':'Accessories'};

    function renderChips(){
      var box=$('#chips');
      box.innerHTML=CHIPS.map(function(lbl){
        var active=(state.filter===lbl)?'active':'';
        return '<button class="chip '+active+'" data-chip="'+lbl+'">'+lbl+'</button>';
      }).join('');
      $$('#chips [data-chip]').forEach(function(b){
        b.addEventListener('click',function(){state.filter=b.getAttribute('data-chip'); render();});
      });
    }
    renderChips();

    function labelMatches(label,r){
      if(label==='All') return true;
      if(label==='On Demo') return !!r.on_demo;
      var cat=(r.category||'').toLowerCase();
      var want=(MAP[label]||label).toLowerCase();
      return cat===want;
    }

    function pickImage(r,kind){
      var direct=(kind==='detail' && (r.detail_image_url || (Array.isArray(r.images)&&r.images[1])))
                  || r.primary_image_url || r.image_url
                  || (Array.isArray(r.images)?r.images[0]:null);
      var storage=r && r.image_path ? (window.ENV && window.ENV.SUPABASE_URL ? (window.ENV.SUPABASE_URL+'/storage/v1/object/public/'+r.image_path) : null) : null;
      return direct || storage || PLACEHOLDER;
    }

    function makeTags(r){
      var tags=[];
      if(Array.isArray(r.tags)) tags = r.tags.slice(0,4);
      if(r.mesh) tags.push('Mesh');
      if(r.dual_zone||r.dualzone) tags.push('Dual-zone');
      if(r.usb_midi) tags.push('USB/MIDI');
      if(r.bluetooth_audio||r.bt) tags.push('Bluetooth');
      // de-dup
      var seen={}; var out=[];
      tags.forEach(function(t){ if(!seen[t]){seen[t]=1; out.push(t);} });
      return out.slice(0,4);
    }

    function renderCard(r){
      var demo=r.on_demo? '<div class="demo">'+(r.on_demo_label||'On Demo')+'</div>' : '';
      return ''+
      '<div class="card" data-id="'+r.id+'">'+
        '<div class="imgbox">'+demo+'<img src="'+pickImage(r,'card')+'" alt="'+(r.name||'')+'" loading="lazy"/></div>'+
        '<div class="content">'+
          '<div class="title">'+(r.name||'')+'</div>'+
          '<div class="desc">'+(r.subtitle||r.short_description||'')+'</div>'+
          '<div class="price">'+AED(r.price)+'</div>'+
          '<div>'+makeTags(r).map(function(t){return '<span class="tag">'+t+'</span>'}).join('')+'</div>'+
          '<div class="line">'+
            '<button class="btn" data-explore="'+r.id+'">Explore</button>'+
            '<label class="cmp"><input type="checkbox" data-compare="'+r.id+'"> Add to compare</label>'+
          '</div>'+
        '</div>'+
      '</div>';
    }

    function render(){
      var list=state.rows.filter(function(r){return labelMatches(state.filter,r)});
      var grid=$('#grid');
      if(!list.length){ grid.innerHTML='<div class="card" style="padding:16px">No items match this view.</div>'; return; }
      grid.innerHTML=list.map(renderCard).join('');
      $$('[data-explore]').forEach(function(b){ b.addEventListener('click',function(e){ openDetail(e.currentTarget.getAttribute('data-explore')); }); });
      $$('[data-compare]').forEach(function(cb){
        var id=cb.getAttribute('data-compare');
        cb.checked=state.compare.has(id);
        cb.addEventListener('change',function(){
          if(cb.checked) state.compare.add(id); else state.compare.delete(id);
          $('#cmpCount').textContent=String(state.compare.size);
        });
      });
      $('#cmpCount').textContent=String(state.compare.size);
    }

    function openDetail(id){
      var r=state.byId.get(String(id)); if(!r) return;
      $('#dTitle').textContent=r.name||'Product';
      var price=AED(r.price), upc=r.upc||r.barcode||'';
      var demo=r.on_demo? '<span class="chip">'+(r.on_demo_label||'On Demo')+'</span>' : '';
      var features=Array.isArray(r.features)?r.features:[];
      var contents=Array.isArray(r.contents)?r.contents:[];
      $('#dBody').innerHTML =
        '<div class="photo"><img src="'+pickImage(r,'detail')+'" alt="'+(r.name||'')+'"/></div>'+
        '<div class="sheet">'+
          '<div>'+demo+' <span class="chip price">'+price+'</span> '+(upc?'<span class="chip">UPC: '+upc+'</span>':'')+'</div>'+
          (r.description? '<div class="section"><h4>Description</h4><div class="muted">'+r.description+'</div></div>' : '')+
          (features.length? '<div class="section"><h4>Key Features</h4><ul>'+features.map(function(f){return '<li>'+f+'</li>'}).join('')+'</ul></div>' : '')+
          (contents.length? '<div class="section"><h4>What\'s Included</h4><ul>'+contents.map(function(c){return '<li>'+c+'</li>'}).join('')+'</ul></div>' : '')+
        '</div>';
      $('#detail').showModal();
    }

    document.addEventListener('click',function(e){
      var id=e.target && e.target.getAttribute && e.target.getAttribute('data-close');
      if(id){ document.getElementById(id).close(); }
    });

    $('#btnCompare').addEventListener('click',function(){
      var rows=Array.from(state.compare).map(function(id){return state.byId.get(String(id))}).filter(Boolean);
      var cols=rows.map(function(r){
        return '<div class="card" style="padding:12px">'+
          '<div class="imgbox"><img src="'+pickImage(r,'card')+'" alt="'+(r.name||'')+'" style="height:160px"/></div>'+
          '<div class="content"><div class="title">'+(r.name||'')+'</div><div class="price">'+AED(r.price)+'</div><div class="muted">'+(r.subtitle||'')+'</div></div>'+
        '</div>';
      }).join('');
      $('#cBody').innerHTML=rows.length? '<div class="grid" style="grid-template-columns:repeat(2,1fr)">'+cols+'</div>' : '<div class="muted" style="padding:12px">Pick items to compare.</div>';
      $('#compare').showModal();
    });

    $('#btnWizard').addEventListener('click',function(){ $('#wizard').showModal(); });

    $('#wGo').addEventListener('click',function(){
      var budget=$('#wBudget').value, noise=$('#wNoise').value, space=$('#wSpace').value, conn=$('#wConn').value;
      function score(r){
        var s=0;
        if(budget.indexOf('Under')>-1) s+= (r.price<=2000)?3:0;
        else if(budget.indexOf('2000 - 5000')>-1) s+= (r.price>=2000 && r.price<=5000)?3:0;
        else if(budget.indexOf('5000 - 9000')>-1) s+= (r.price>5000 && r.price<=9000)?3:0;
        else if(budget.indexOf('Over')>-1) s+= (r.price>9000)?3:0;
        if(noise.indexOf('High')===0 && (r.mesh || (r.tags||[]).indexOf('Mesh')>-1)) s+=2;
        if(space==='Compact' && /compact|small/i.test((r.subtitle||r.description||''))) s+=2;
        if(conn==='Bluetooth' && (r.bluetooth_audio||r.bt)) s+=2;
        if(conn==='USB/MIDI' && r.usb_midi) s+=2;
        return s;
      }
      var sorted=state.rows.filter(function(r){return (r.category||'').toLowerCase()==='drum kits'}).sort(function(a,b){return score(b)-score(a)});
      var top=sorted[0]; var out=$('#wOut');
      if(!top){ out.innerHTML='<div class="muted">No match found.</div>'; return;}
      out.innerHTML='<div class="section" style="border-color:#2b3642">'+
        '<div style="color:#63f5ff;font-weight:800;margin-bottom:6px">Your Match</div>'+
        '<div><strong>'+top.name+'</strong> looks like a great fit at <strong>'+AED(top.price)+'</strong>.</div>'+
        '<div class="muted" style="margin-top:6px">Because it matches your budget and preferences.</div>'+
        '<div style="margin-top:10px"><button class="btn btn-primary" data-explore="'+top.id+'">View This Kit</button></div>'+
      '</div>';
      out.querySelector('[data-explore]').addEventListener('click',function(){ openDetail(top.id); $('#wizard').close(); });
    });

    async function fetchRows(){
      var grid=$('#grid');
      if(!window.ENV || !window.ENV.SUPABASE_URL || !window.ENV.SUPABASE_ANON_KEY){
        console.error('ENV missing', window.ENV);
        grid.innerHTML='<div class="card" style="padding:16px">env.js is missing SUPABASE_URL / SUPABASE_ANON_KEY.</div>';
        return;
      }
      var url=window.ENV.SUPABASE_URL+'/rest/v1/drum_kits?select=*&order=price.asc';
      try{
        var res=await fetch(url,{headers:{apikey:window.ENV.SUPABASE_ANON_KEY,Authorization:'Bearer '+window.ENV.SUPABASE_ANON_KEY}});
        if(!res.ok){
          var txt=await res.text();
          grid.innerHTML='<div class="card" style="padding:16px">Could not load products ('+res.status+').<div class="muted" style="margin-top:6px">'+txt.replace(/</g,'&lt;').slice(0,240)+'</div></div>';
          console.error('Supabase REST error', res.status, txt);
          return;
        }
        var rows=await res.json();
        rows=rows.filter(function(r){ return r.is_active!==false; });
        state.rows=rows;
        state.byId=new Map(rows.map(function(r){ return [String(r.id), r]; }));
        console.log('Loaded rows:', rows.length, rows);
        render();
      }catch(err){
        grid.innerHTML='<div class="card" style="padding:16px">Network error loading products.<div class="muted" style="margin-top:6px">'+(err && err.message ? err.message : String(err))+'</div></div>';
        console.error('Fetch failed', err);
      }
    }

    fetchRows();
  })();
  </script>
</body>
</html>
