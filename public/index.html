<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Alesis Kiosk</title>

<!-- base: keep existing theme intact; only tiny additions below -->
<style>
:root{
  --bg:#0b1316; --panel:#111b1f; --line:#1e3b40; --pill:#0e555c; --pill-hi:#0ebac5;
  --text:#dfeff1; --muted:#99b6bb;
  --radius:16px;
}
*{box-sizing:border-box}
html,body{height:100%;background:var(--bg);color:var(--text);margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;}
a,button{cursor:pointer}
img{max-width:100%;display:block}
/* ===== grid ===== */
.wrap{max-width:1200px;margin:0 auto;padding:18px;}
.grid{
  display:grid; gap:16px;
  grid-template-columns:repeat(auto-fill,minmax(280px,1fr));
}
.card{
  background:var(--panel); border:1px solid var(--line); border-radius:16px; overflow:hidden;
  display:flex; flex-direction:column; position:relative; padding-bottom:56px; /* space for compare ctl */
}
.card .hero{aspect-ratio:16/9; background:#0a0f11; overflow:hidden;}
.card .pad{padding:12px;}
.title{font-weight:800; margin:8px 0 4px;}
.muted{color:var(--muted);font-size:14px}
.pills{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
.pill{
  background:linear-gradient(180deg,#0b3a41,#0b2f34);
  border:1px solid var(--line); border-radius:28px; padding:8px 14px; font-weight:700; color:#c9f9ff;
  display:inline-flex; align-items:center; gap:8px;
}
.pill.price{ background:linear-gradient(180deg,#0ebac566,#0ebac533); color:#001; font-weight:900; }
.price .num{letter-spacing:.3px}
.aed-icon{
  width:16px;height:16px;display:inline-block;flex:0 0 16px;vertical-align:-2px;
  -webkit-mask:url("/aed.svg") no-repeat center / contain;
  mask:url("/aed.svg") no-repeat center / contain;
  background:#000; /* always black */
}
.badges{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
.badge{background:#0c3338;border:1px solid var(--line);border-radius:28px;padding:8px 12px;color:#bfefff}

/* compare control pinned bottom-right */
.cmpCtl{
  position:absolute; right:12px; bottom:10px; display:flex; align-items:center; gap:8px;
  color:#e7faff; font-size:14px;
}

/* ===== sticky header ===== */
.header{
  position:sticky; top:0; z-index:5; background:linear-gradient(180deg,rgba(5,12,14,.92),rgba(5,12,14,.65));
  backdrop-filter:saturate(1.2) blur(6px); border-bottom:1px solid var(--line);
}
.header .bar{max-width:1200px;margin:0 auto;display:flex;align-items:center;gap:10px;padding:10px 18px;}
.header .right{margin-left:auto;display:flex;gap:8px;align-items:center}
.btn{
  border:1px solid var(--line); background:#0c2b30; color:#c9f9ff; padding:10px 14px; border-radius:999px; font-weight:800;
}
.btn.ghost{background:transparent}
.btn.pill{border-radius:24px;}
.btn.primary{background:#0ebac5; color:#012b2f;}
.btn.small{padding:6px 10px; font-size:13px}

/* FAB when scrolled */
#compareFab{
  position:fixed; right:16px; bottom:16px; display:none; align-items:center; gap:8px;
}

/* ===== detail modal ===== */
#detail{ position:fixed; inset:0; display:none; z-index:30; }
#detail .back{ position:absolute; inset:0; background:rgba(0,0,0,.65); }
#detail .sheet{
  position:absolute; inset:24px; background:linear-gradient(180deg,#0c1417,#0b1214);
  border:1px solid var(--line); border-radius:20px; overflow:auto; padding:12px;
}
#detail .grid{ grid-template-columns: 1fr 1.2fr; gap:16px; }
#detail .btn.close{ position:absolute; top:12px; right:12px; z-index:3; }
#detail .tiny{ font-size:13px; padding:6px 10px; }
.pill-demo{ font-size:13px; padding:6px 10px; border-radius:18px; background:#f6c33a; color:#000; border:1px solid #b98f13; }
.section{ border:1px solid var(--line); border-radius:14px; padding:12px; margin:10px 0; }
.section .h{ font-weight:900; color:#bfefff; margin-bottom:6px; }
.dotlist{ padding-left:18px; margin:0; }
.dotlist li{ margin:6px 0; }

/* quick specs table */
.qs{ width:100%; border-collapse:collapse; }
.qs td{ padding:6px 8px; border-bottom:1px dotted var(--line);}
.qs td:first-child{ color:#bfefff; width:50% }

/* ===== compare modal ===== */
#cmp{ position:fixed; inset:0; display:none; z-index:40;}
#cmp .back{ position:absolute; inset:0; background:rgba(0,0,0,.65);}
#cmp .sheet{ position:absolute; inset:24px; background:linear-gradient(180deg,#0c1417,#0b1214);
  border:1px solid var(--line); border-radius:20px; overflow:auto;}
#cmp .head{ position:sticky; top:0; background:linear-gradient(180deg,rgba(12,20,23,.96),rgba(12,20,23,.86)); padding:12px; border-bottom:1px solid var(--line); display:flex; align-items:center; gap:8px;}
#cmp .cols{ display:grid; gap:12px; grid-template-columns:repeat(auto-fit,minmax(320px,1fr)); padding:12px;}
#cmp .col{ background:rgba(255,255,255,.02); border:1px solid var(--line); border-radius:14px; overflow:hidden;}
#cmp .col .pad{ padding:12px;}
#cmp .specs{ width:100%; border-collapse:collapse;}
#cmp .specs td{ padding:8px 6px; border-bottom:1px dotted var(--line);}
#cmp .specs td:first-child{ color:#bfefff }

/* responsive detail grid */
@media (max-width: 980px){
  #detail .grid{ grid-template-columns: 1fr; }
}

</style>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<script src="/env.js"></script>
  <link rel="stylesheet" href="/kiosk-fixes.css">
</head>
<body>

<!-- Sticky header -->
<div class="header">
  <div class="bar">
    <div style="font-weight:900">Alesis Electronic Drums Kiosk</div>
    <div class="right">
      <button id="btnCompare" class="btn">Compare (<span id="cmpCount">0</span>)</button>
    </div>
  </div>
</div>

<div class="wrap">
  <div id="grid" class="grid"></div>
</div>

<!-- Compare FAB -->
<button id="compareFab" class="btn primary">
  Compare (<span id="fabCount">0</span>)
</button>

<!-- Detail Modal -->
<div id="detail">
  <div class="back"></div>
  <div class="sheet">
    <button class="btn small close" id="dClose">Close</button>
    <div id="dTop" class="pills" style="gap:10px;margin:6px 6px 10px 6px"></div>
    <div class="grid" id="dGrid">
      <div id="dImg" class="section" style="min-height:280px"></div>
      <div id="dMeta"></div>
    </div>
  </div>
</div>

<!-- Compare Modal -->
<div id="cmp">
  <div class="back"></div>
  <div class="sheet">
    <div class="head">
      <div style="font-weight:900;color:#bfefff">Compare</div>
      <div class="muted">Tap a card’s checkbox to add/remove.</div>
      <button id="cmpClose" class="btn small" style="margin-left:auto">Close</button>
    </div>
    <div id="ladder"></div>
    <div id="cmpCols" class="cols"></div>
  </div>
</div>

<script>
/* ================== helpers ================== */
const $ = sel => document.querySelector(sel);
const fmt = n => Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
const AED = n => `<span class="pill price"><span class="aed-icon"></span><span class="num">${fmt(n)}</span></span>`;
const yesno = v => (v===true || v==='true' || v===1 || v==='1') ? 'Yes' : (v===false||v==='false'||v===0||v==='0') ? 'No' : (v ?? '—');

const State = {
  rows: [],
  byId: new Map(),
  compare: new Set()
};

/* qVal: read value by key from r.specs.quick OR from data fields/fallbacks */
function qVal(item, r){
  // direct value from quick spec list
  if(item && item.value!=null && item.value!=='') return item.value;

  const key = item && item.key;
  const data = (r.specs && r.specs.data) || {};
  const top = r || {};
  const candidates = [
    key,
    key && key.replace(/-(in|mm|cm|kg)$/,''),
  ].filter(Boolean);

  for(const k of candidates){
    if(k && data[k]!=null) return item?.format==='yesno' ? yesno(data[k]) : data[k];
    if(k && top[k]!=null)  return item?.format==='yesno' ? yesno(top[k])  : top[k];
  }

  // special mappings for amps / headphones / accessories
  if(r.category && /ampl/i.test(r.category)){
    if(item.label==='Power') return (data.watt_rms||r.amp_watt_rms||'?')+' W RMS / '+(data.watt_peak||r.watt_peak||'?')+' W peak';
    if(item.label==='Woofer') return (data.woofer_in||r.amp_woofer_in||'?') + '"';
    if(item.label?.startsWith('Max SPL')) return (data.max_spl_db||r.amp_max_spl_db||'?')+' dB';
    if(item.label?.startsWith('Freq')) return (data.freq_low_hz||r.amp_freq_low_hz||'?')+' Hz – '+(data.freq_high_hz||r.amp_freq_high_hz||'?')+' Hz';
  }

  // smart fallbacks for drum kits
  if(item.label==='Dimensions') return (data.dimensions_cm || data.dimensions_mm || top.dimensions_cm || '—');
  if(item.label==='Weight') return (data.weight_kg || top.weight_kg || '—');

  return '—';
}

function specRow(label, value){
  return `<tr><td>${label}</td><td style="text-align:right">${(value===undefined||value===null||value==='')?'—':value}</td></tr>`;
}

/* ================== render grid ================== */
function card(r){
  const tags = [];
  if(r.mesh) tags.push('Mesh');
  if(r.usb_midi) tags.push('USB/MIDI');
  if(r.bluetooth_audio) tags.push('Bluetooth');

  return `
  <div class="card" data-id="${r.id}">
    <div class="hero"><img src="${r.primary_image_url||r.detail_image_url||''}" alt=""></div>
    <div class="pad">
      <div class="pills">
        ${AED(r.price||0)}
        ${r.upc_code ? `<span class="pill">UPC: ${r.upc_code}</span>`:''}
      </div>
      <div class="title">${r.name||''}</div>
      ${r.upc_code?`<div class="muted">UPC: ${r.upc_code}</div>`:''}
      <div class="badges">
        ${tags.map(t=>`<span class="badge">${t}</span>`).join('')}
      </div>
    </div>

    <!-- compare ctl pinned -->
    <label class="cmpCtl">
      <input type="checkbox" data-cmp data-id="${r.id}">
      <span>Add to compare</span>
    </label>

    <!-- overlay to open detail -->
    <a class="tap-open" style="position:absolute;inset:0" aria-label="Open"></a>
  </div>`;
}

/* ================== detail modal ================== */
function openDetail(id){
  const r = State.byId.get(String(id)); if(!r) return;
  const modal = $('#detail');
  const top = $('#dTop');

  const demo = (r.on_demo || r.on_demo_label) ? `<span class="pill-demo">${r.on_demo_label || 'Play this kit on demo'}</span>` : '';

  top.innerHTML = `
    ${AED(r.price||0)}
    ${r.upc_code ? `<span class="pill">UPC: ${r.upc_code}</span>`:''}
  `;

  // header title + small demo chip beside it
  const title = `<div style="display:flex;align-items:center;gap:10px;margin:6px 6px 0 6px">
    <div class="title" id="dTitle" style="font-size:22px">${r.name||''}</div>
    ${demo}
  </div>`;

  $('#dImg').innerHTML = `<img style="width:100%;border-radius:12px" src="${r.detail_image_url||r.primary_image_url||''}" alt="">`;

  // quick specs
  const qspecs = (r.specs && r.specs.quick) || (()=>{
    if(/drum kit/i.test(r.category||'') || !r.category){
      return [
        {label:'Category', value:'Drum Kits'},
        {label:'Mesh', key:'mesh', format:'yesno'},
        {label:'USB/MIDI', key:'usb_midi', format:'yesno'},
        {label:'Bluetooth', key:'bluetooth_audio', format:'yesno'},
        {label:'Factory kits', key:'kits_factory'},
        {label:'User kits', key:'kits_user'},
        {label:'Sounds', key:'sounds'},
        {label:'Toms', key:'toms_count'},
        {label:'Crash cymbals', key:'crash_count'},
        {label:'Ride zones', key:'ride_zones'},
        {label:'Kick tower', key:'kick_tower', format:'yesno'},
        {label:'Dimensions', value:qVal({label:'Dimensions'}, r)},
        {label:'Weight', value:qVal({label:'Weight'}, r)},
      ];
    }
    if(/ampl/i.test(r.category||'')){
      return [
        {label:'Category', value:'Drum Amplification'},
        {label:'Woofer', value:qVal({label:'Woofer'}, r)},
        {label:'Power', value:qVal({label:'Power'}, r)},
        {label:'Max SPL', value:qVal({label:'Max SPL'}, r)},
        {label:'Freq. Response', value:qVal({label:'Freq. Response'}, r)},
        {label:'Inputs', value: (r.amp_inputs || (r.specs?.data?.inputs) || '—')},
        {label:'Outputs', value: (r.amp_outputs || (r.specs?.data?.outputs) || '—')},
        {label:'Dimensions', value: (r.amp_dimensions_mm || r.specs?.data?.dimensions_mm || '—')},
        {label:'Weight', value: (r.amp_weight_kg || r.specs?.data?.weight_kg || '—')},
      ];
    }
    return [{label:'Category', value:r.category||'—'}];
  })();

  const QS = qspecs.map(it => specRow(it.label, qVal(it,r))).join('');

  // included / not included
  const inc = Array.isArray(r.contents)?r.contents:[];
  const notinc = (r.specs && r.specs.not_included) || [];

  $('#dMeta').innerHTML = `
    ${title}
    <div class="section">
      <div class="h">Description</div>
      <div class="muted">${r.description||''}</div>
    </div>
    <div class="section">
      <div class="h">Key Features</div>
      <ul class="dotlist">${(r.features||[]).map(x=>`<li>${x}</li>`).join('')}</ul>
    </div>
    ${inc.length?`<div class="section"><div class="h">What's Included</div><ul class="dotlist">${inc.map(x=>`<li>${x}</li>`).join('')}</ul></div>`:''}
    ${notinc.length?`<div class="section"><div class="h">What's NOT Included</div><ul class="dotlist">${notinc.map(x=>`<li>${x}</li>`).join('')}</ul></div>`:''}
    <div class="section">
      <div class="h">Quick Specs</div>
      <table class="qs">${QS}</table>
    </div>
  `;

  $('#detail').style.display='block';
}

/* ================== compare ================== */
function openCompare(){
  const ids = [...State.compare];
  const rows = ids.map(id=>State.byId.get(id)).filter(Boolean);
  const c = $('#cmpCols');

  // recommendation ladder (cheapest -> better)
  if(rows.length>=2){
    const sorted = rows.slice().sort((a,b)=>(+a.price||0)-(+b.price||0));
    const base = sorted[0], better = sorted[1];
    const diff = (+better.price||0)-(+base.price||0);
    const pct = diff && base.price ? Math.round(diff/base.price*100) : 0;
    $('#ladder').innerHTML = `
      <div class="section" style="margin:12px">
        <div style="font-weight:900;color:#7ff5ff;margin-bottom:6px">Recommendation Ladder</div>
        <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:6px">
          <span class="pill">Baseline</span> <b>${base.name}</b> — ${AED(base.price)}
        </div>
        <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:6px">
          <span class="pill">Jump to</span> <b>${better.name}</b> — ${AED(better.price)}
          <span class="pill" style="background:#143a42;border:1px solid #1a4f59">+${AED(diff)} (${pct}%)</span>
        </div>
        <div class="muted">Why: more factory kits, more sounds, Bluetooth (when available).</div>
      </div>`;
  } else {
    $('#ladder').innerHTML = '';
  }

  c.innerHTML = rows.map(r=>{
    const quick = (r.specs && r.specs.quick) || [];
    const rowsHtml = quick.length
      ? quick.map(it=>specRow(it.label||it.key, qVal(it,r))).join('')
      : [
          specRow('Mesh', yesno(r.mesh)),
          specRow('USB/MIDI', yesno(r.usb_midi)),
          specRow('Bluetooth', yesno(r.bluetooth_audio)),
          specRow('Factory kits', r.kits_factory||'—'),
          specRow('Sounds', r.sounds||'—'),
          specRow('Ride zones', r.ride_zones||'—'),
          specRow('Kick tower', yesno(r.kick_tower))
        ].join('');
    return `
      <div class="col">
        <div class="hero"><img src="${r.primary_image_url||r.detail_image_url||''}" alt=""></div>
        <div class="pad">
          ${AED(r.price||0)}
          <div class="title" style="margin-top:6px">${r.name||''}</div>
          <table class="specs">${rowsHtml}</table>
          <div style="display:flex; gap:8px; margin-top:10px">
            <button class="btn small ghost" data-open="${r.id}">Open</button>
            <button class="btn small ghost" data-remove="${r.id}">Remove</button>
          </div>
        </div>
      </div>
    `;
  }).join('');
  $('#cmp').style.display='block';

  // wire buttons
  c.querySelectorAll('[data-open]').forEach(b=>b.onclick=()=>{ closeCompare(); openDetail(b.dataset.open); });
  c.querySelectorAll('[data-remove]').forEach(b=>b.onclick=()=>{ toggleCompare(b.dataset.remove,false); });
}
function closeCompare(){ $('#cmp').style.display='none'; }

/* ================== load ================== */
async function load(){
  const url = `${window.ENV.SUPABASE_URL}/rest/v1/drum_kits`+
    `?select=id,name,description,price,upc_code,slug,category,primary_image_url,detail_image_url,`+
    `on_demo,on_demo_label,features,contents,specs,kits_factory,kits_user,sounds,mesh,usb_midi,bluetooth_audio,`+
    `toms_count,crash_count,ride_zones,kick_tower,dimensions_cm,weight_kg,amp_*,watt_peak`;
  const res = await fetch(url, {
    headers:{
      apikey: window.ENV.SUPABASE_ANON_KEY,
      Authorization: `Bearer ${window.ENV.SUPABASE_ANON_KEY}`
    }
  });
  if(!res.ok){
    $('#grid').innerHTML = `<div class="muted">Can’t load data (HTTP ${res.status}). Check /public/env.js key + RLS.</div>`;
    return;
  }
  const rows = await res.json();
  State.rows = rows;
  State.byId = new Map(rows.map(r=>[String(r.id),r]));

  // render cards
  $('#grid').innerHTML = rows.map(card).join('');

  // wire compare checkboxes
  document.querySelectorAll('[data-cmp]').forEach(ch=>{
    ch.addEventListener('change', ev=>{
      toggleCompare(ev.target.dataset.id, ev.target.checked);
    });
  });
  // open detail on tap
  document.querySelectorAll('.card .tap-open').forEach(a=>{
    a.addEventListener('click', e=>{
      const id = e.currentTarget.closest('.card').dataset.id;
      openDetail(id);
    });
  });
  syncCompareUi();
}

/* ================== compare state ================== */
function toggleCompare(id, checked){
  if(checked===undefined){
    if(State.compare.has(id)) State.compare.delete(id);
    else State.compare.add(id);
  }else{
    if(checked) State.compare.add(id); else State.compare.delete(id);
  }
  // reflect to checkboxes
  document.querySelectorAll(`[data-cmp][data-id="${id}"]`).forEach(ch=>{ ch.checked = State.compare.has(id); });
  syncCompareUi();
}
function syncCompareUi(){
  const n = State.compare.size;
  $('#cmpCount').textContent = n;
  $('#fabCount').textContent = n;
  $('#compareFab').style.display = n ? 'flex' : 'none';
}

/* ================== wire header / modals ================== */
function wire(){
  $('#btnCompare').onclick=()=> openCompare();
  $('#compareFab').onclick=()=> openCompare();

  // close detail
  $('#dClose').onclick=()=> $('#detail').style.display='none';
  $('#detail .back').onclick=()=> $('#detail').style.display='none';

  // close compare
  $('#cmpClose').onclick= closeCompare;
  $('#cmp .back').onclick= closeCompare;
}

/* ================== boot ================== */
document.addEventListener('DOMContentLoaded', async ()=>{
  wire();
  await load();
});
</script>
  <script src="/kiosk-fixes.js"></script>
</body>
</html>
